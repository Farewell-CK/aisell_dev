# 数据库脱敏迁移工具

## 概述

`aisell_dev/migrate_to_sqlite.py`是一个安全的数据库迁移工具，用于将MySQL数据库迁移到SQLite，同时保护敏感数据。

## 主要功能

### 🔒 数据安全保护
- **自动脱敏**: 自动识别并脱敏敏感字段
- **数据限制**: 每个表只保留10行示例数据
- **缓存机制**: 确保相同值脱敏后保持一致

### 📊 支持的敏感字段类型

#### 微信相关字段
- `wechat_id` - 微信ID
- `wechat_no` - 微信号
- `wechat_nickname` - 微信昵称
- `wechat_group_id` - 微信群ID
- `wechat_group_nickname` - 微信群昵称
- `belong_wechat_id` - 所属微信ID
- `source_wechat_id` - 来源微信ID
- `sender_wechat_id` - 发送者微信ID

#### 公司相关字段
- `company_name` - 公司名称
- `company_id` - 公司ID
- `tenant_id` - 租户ID

#### 用户相关字段
- `user_id` - 用户ID
- `username` - 用户名
- `name` - 姓名
- `mobile_no` - 手机号
- `phone` - 电话
- `email` - 邮箱

#### 聊天记录相关字段
- `content` - 内容
- `text` - 文本
- `message` - 消息
- `chat_content` - 聊天内容
- `reply_content` - 回复内容

#### 其他敏感字段
- `password` - 密码
- `token` - 令牌
- `api_key` - API密钥
- `secret` - 密钥

## 脱敏规则

### 微信ID类字段
```
原始值: wx123456789
脱敏后: wx_a1b2c3d4
```

### 微信昵称类字段
```
原始值: 张三
脱敏后: 用户_a1b2c3
```

### 公司名和姓名
```
原始值: 北京科技有限公司
脱敏后: 公司_a1b2c3
```

### 手机号
```
原始值: 13812345678
脱敏后: 138****5678
```

### 邮箱
```
原始值: test@example.com
脱敏后: t***@example.com
```

### 聊天内容
```
原始值: 你好，我想了解一下你们的产品
脱敏后: [脱敏内容_15字符]
```

### 密码等敏感信息
```
原始值: mypassword123
脱敏后: ***MASKED***
```

## 使用方法

### 1. 运行迁移脚本

```bash
python migrate_to_sqlite.py
```

## 迁移流程

1. **备份配置**: 自动备份原始数据库配置
2. **分析数据库**: 获取所有表结构和数据
3. **生成报告**: 创建详细的迁移报告
4. **数据脱敏**: 对敏感字段进行脱敏处理
5. **数据限制**: 每个表只保留10行数据
6. **导出JSON**: 导出脱敏后的数据到JSON文件
7. **创建SQLite**: 创建包含脱敏数据的SQLite数据库
8. **切换配置**: 自动切换到SQLite配置

## 输出文件

### 迁移报告
- 文件: `数据库迁移报告.html`
- 内容: 详细的表结构信息和数据状态

### 脱敏数据备份
- 文件: `database_export_masked.json`
- 内容: 包含脱敏数据的完整备份

### SQLite数据库
- 文件: `database/sale.db`
- 内容: 包含脱敏数据的SQLite数据库

### 配置备份
- 文件: `configs/database_backup_YYYYMMDD_HHMMSS.yaml`
- 内容: 原始数据库配置备份

## 安全说明

### 🔒 数据保护措施
- 所有敏感数据在迁移过程中自动脱敏
- 原始敏感数据不会被保存到新数据库
- 脱敏算法使用哈希函数确保一致性
- 缓存机制确保相同值脱敏后保持一致

### 📊 数据限制
- 每个表最多保留10行示例数据
- 保留的数据主要用于测试和开发
- 生产环境数据量大幅减少

### 🛡️ 隐私保护
- 微信ID、昵称等个人信息被完全替换
- 聊天记录内容被脱敏处理
- 公司名称等商业信息被保护
- 联系方式被部分脱敏

## 注意事项

### ⚠️ 重要提醒
1. **备份原始数据**: 迁移前请确保原始数据已备份
2. **测试环境**: 建议先在测试环境运行
3. **数据验证**: 迁移后请验证应用功能正常
4. **配置检查**: 确认SQLite配置正确

### 🔧 故障排除
- 如果迁移失败，检查数据库连接配置
- 确保有足够的磁盘空间
- 检查文件权限是否正确

## 技术实现

### 核心类
- `SensitiveDataMigrator`: 敏感数据处理迁移器
- `DatabaseMigrator`: 基础数据库迁移器

### 主要方法
- `mask_sensitive_data()`: 数据脱敏处理
- `get_table_data()`: 获取限制和脱敏数据
- `migrate_to_sqlite()`: 迁移到SQLite
- `export_to_json()`: 导出脱敏数据

### 依赖库
- `sqlalchemy`: 数据库操作
- `pymysql`: MySQL连接
- `pandas`: 数据处理
- `pyyaml`: 配置文件处理

## 更新日志

### v1.0.0 (2025-07-01)
- 初始版本发布
- 支持MySQL到SQLite迁移
- 实现敏感数据自动脱敏
- 添加数据限制功能
- 提供完整的测试工具 