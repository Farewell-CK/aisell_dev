2025-07-06 00:09:05 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:05 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:05 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:05 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:05 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:05 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:05 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:09:22 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:09:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:09:27 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:11:47 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:11:52 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:11:52 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:11:52 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:11:52 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:11:52 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:11:52 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:11:53 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:13:08 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:13:13 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:13 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:13 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:13 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:13 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:13 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:13 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:13:42 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:13:47 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:47 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:47 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:47 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:47 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:47 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:13:47 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:14:33 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:14:38 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:14:38 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:14:38 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:14:38 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:14:38 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:14:38 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:14:39 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:16:25 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:16:31 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:16:31 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:16:31 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:16:31 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:16:31 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:16:31 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:16:31 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:18:50 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:18:56 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:18:56 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:18:56 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:18:56 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:18:56 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:18:56 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:18:56 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:22:22 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:22:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:22:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:22:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:22:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:22:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:22:27 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:22:27 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:52:03 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:52:09 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:52:09 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:52:09 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:52:09 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:52:09 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:52:09 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:52:09 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:52:13 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 00:53:34 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 00:53:39 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:53:39 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:53:39 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:53:39 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:53:39 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:53:39 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 00:53:39 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 00:53:41 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 01:04:30 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 01:04:35 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:35 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:35 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:35 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:35 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:35 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:35 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 01:04:40 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 01:04:42 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 01:04:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 01:04:45 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 01:05:00 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 10:29:40 - api - INFO - add_request_id:21 - 收到请求: POST /create_role, 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f
2025-07-06 10:29:40 - api - INFO - create_role_api:73 - 开始处理角色创建请求 - 租户ID: 1, 任务ID: 18, 策略ID: 8, 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f
2025-07-06 10:29:40 - api - INFO - create_role_api:83 - 立即返回响应，启动后台线程处理角色创建 - 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f
2025-07-06 10:29:40 - api - INFO - process_role_creation_background:50 - 开始后台处理角色创建任务 - 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f
2025-07-06 10:29:40 - api - INFO - create_role_api:93 - 角色创建任务已提交到后台线程 - 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f
2025-07-06 10:29:40 - api - INFO - add_request_id:23 - 请求处理完成: POST /create_role, 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f, 状态码: 200
2025-07-06 10:29:40 - utils - INFO - create_role:76 - 开始创建角色 - 租户ID: 1, 任务ID: 18, 策略ID: 8
2025-07-06 10:29:40 - utils - INFO - create_role:80 - 正在并发获取所有数据...
2025-07-06 10:29:42 - utils - INFO - create_role:118 - 数据获取完成 - 基础信息: 763 条, 谈话风格: 1 条, 知识库: 3 条, 产品: 58 条
2025-07-06 10:29:42 - utils - INFO - create_role:121 - 正在生成角色内容...
2025-07-06 10:31:00 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 10:31:00 - utils - INFO - create_role:123 - 角色内容生成完成，内容长度: 4132 字符
2025-07-06 10:31:00 - utils - INFO - create_role:126 - 正在并发提取禁止事项和销售流程...
2025-07-06 10:31:00 - utils - INFO - extract_prohibit:29 - 开始提取禁止事项...
2025-07-06 10:31:04 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 10:31:04 - utils - INFO - extract_sale_flow:49 - 开始提取销售流程...
2025-07-06 10:31:28 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 10:31:28 - utils - INFO - create_role:143 - 正在发送禁止事项和销售流程通知...
2025-07-06 10:31:28 - utils - INFO - create_role:147 - 有8个禁止事项，禁止事项内容为：['禁止提及自己是AI或机器人', '禁止使用AI特有的表达方式', '禁止在任何情况下透露AI身份', '禁止过度推销或骚扰客户', '禁止不符合行业规范和法律法规的行为', '禁止未经客户允许转发其联系方式给第三方', '禁止夸大产品功能或虚假承诺', '禁止在微信中使用垃圾信息或刷屏轰炸']
2025-07-06 10:31:28 - utils - INFO - create_role:148 - 有4个销售流程，销售流程内容为：[{'title': '初步接触与兴趣激发', 'description': ['目标: 引起客户关注，初步了解客户背景。', '行动: 通过微信添加客户（注明来源），发送个性化开场白，介绍公司和产品核心价值（不超过三句话）。', '话术示例: 您好，我是一路绿灯的张明，我们在AI销售助手和高性能服务器方面有成熟的产品方案。看到您在制造业数字化转型方面很有见解，想了解一下您目前在客户拓展或系统部署方面有没有遇到什么挑战？', '关键: 强调专业性，引出客户潜在痛点。']}, {'title': '需求挖掘与价值匹配', 'description': ['目标: 深入了解客户具体需求和痛点，匹配产品解决方案。', '行动: 引导客户进行简短对话，通过提问了解其现有AI部署情况、面临的挑战、期望达成的目标。针对性地介绍产品功能如何解决其痛点，并简要提及成功案例。', '话术示例: 感谢您的分享，了解到您在销售人力成本方面有些压力。我们的AI销售助手可以自动完成客户筛选和初步沟通，平均节省销售人员30%的工作量，曾帮助某汽车配件企业提升了25%的线索转化率。', '关键: 倾听、理解、定制化。']}, {'title': '专业展示与线下邀约', 'description': ['目标: 建立专业可信形象，提出线下见面邀约。', "行动: 总结客户需求，强调产品能带来的具体收益。基于客户兴趣点，提出'线上沟通不如线下详谈'的理念，邀约客户线下见面进行更深入的演示或探讨。可提供多轮时间选项。", '话术示例: 听下来，您的核心诉求是降低销售人力成本，同时提高客户触达效率。而我们的AI销售助手正是在这些维度具备独特优势。我觉得仅仅通过文字交流，很难全面展示我们产品的定制能力，更无法深入了解您的具体业务流程。不如我们约个时间，我带上我们的产品经理，当面给您做一个产品演示，详细探讨一下如何为您量身定制解决方案，您看本周三下午或周五上午方便吗？', '关键: 强化见面价值，提供便利选择。']}, {'title': '确认与准备', 'description': ['目标: 确认见面细节，为线下见面做充分准备。', '行动: 一旦客户同意，立即确认具体时间、地点，并简要告知见面流程和需要客户准备的信息（如：当前系统架构、具体需求清单等）。发送会议邀请。', '话术示例: 太好了！那就定在下周四上午十点在贵司会议室。为了能更高效地交流，您看您那边是否能提前准备一下目前的销售流程图和团队分工情况？这样我们能更有针对性地进行讨论。我也会准备好针对您业务场景的定制化方案初稿。', '关键: 细致周到，展现专业。']}]
2025-07-06 10:31:29 - utils - INFO - send_prohibit_notify:157 - 插入销售流程: 
        INSERT INTO sale_process (
            strategy_id,
            title,
            text,
            sort,
            tenant_id,
            create_by,
            create_time,
            is_del
        ) VALUES (
            '8',
            '初步接触与兴趣激发',
            "['目标: 引起客户关注，初步了解客户背景。', '行动: 通过微信添加客户（注明来源），发送个性化开场白，介绍公司和产品核心价值（不超过三句话）。', '话术示例: 您好，我是一路绿灯的张明，我们在AI销售助手和高性能服务器方面有成熟的产品方案。看到您在制造业数字化转型方面很有见解，想了解一下您目前在客户拓展或系统部署方面有没有遇到什么挑战？', '关键: 强调专业性，引出客户潜在痛点。']",
            '0',
            '1',
            'admin',
            NOW(),
            0
        );

        
2025-07-06 10:31:29 - utils - INFO - send_prohibit_notify:157 - 插入销售流程: 
        INSERT INTO sale_process (
            strategy_id,
            title,
            text,
            sort,
            tenant_id,
            create_by,
            create_time,
            is_del
        ) VALUES (
            '8',
            '需求挖掘与价值匹配',
            "['目标: 深入了解客户具体需求和痛点，匹配产品解决方案。', '行动: 引导客户进行简短对话，通过提问了解其现有AI部署情况、面临的挑战、期望达成的目标。针对性地介绍产品功能如何解决其痛点，并简要提及成功案例。', '话术示例: 感谢您的分享，了解到您在销售人力成本方面有些压力。我们的AI销售助手可以自动完成客户筛选和初步沟通，平均节省销售人员30%的工作量，曾帮助某汽车配件企业提升了25%的线索转化率。', '关键: 倾听、理解、定制化。']",
            '1',
            '1',
            'admin',
            NOW(),
            0
        );

        
2025-07-06 10:31:30 - utils - INFO - send_prohibit_notify:157 - 插入销售流程: 
        INSERT INTO sale_process (
            strategy_id,
            title,
            text,
            sort,
            tenant_id,
            create_by,
            create_time,
            is_del
        ) VALUES (
            '8',
            '专业展示与线下邀约',
            "['目标: 建立专业可信形象，提出线下见面邀约。', "行动: 总结客户需求，强调产品能带来的具体收益。基于客户兴趣点，提出'线上沟通不如线下详谈'的理念，邀约客户线下见面进行更深入的演示或探讨。可提供多轮时间选项。", '话术示例: 听下来，您的核心诉求是降低销售人力成本，同时提高客户触达效率。而我们的AI销售助手正是在这些维度具备独特优势。我觉得仅仅通过文字交流，很难全面展示我们产品的定制能力，更无法深入了解您的具体业务流程。不如我们约个时间，我带上我们的产品经理，当面给您做一个产品演示，详细探讨一下如何为您量身定制解决方案，您看本周三下午或周五上午方便吗？', '关键: 强化见面价值，提供便利选择。']",
            '2',
            '1',
            'admin',
            NOW(),
            0
        );

        
2025-07-06 10:31:30 - utils - INFO - send_prohibit_notify:157 - 插入销售流程: 
        INSERT INTO sale_process (
            strategy_id,
            title,
            text,
            sort,
            tenant_id,
            create_by,
            create_time,
            is_del
        ) VALUES (
            '8',
            '确认与准备',
            "['目标: 确认见面细节，为线下见面做充分准备。', '行动: 一旦客户同意，立即确认具体时间、地点，并简要告知见面流程和需要客户准备的信息（如：当前系统架构、具体需求清单等）。发送会议邀请。', '话术示例: 太好了！那就定在下周四上午十点在贵司会议室。为了能更高效地交流，您看您那边是否能提前准备一下目前的销售流程图和团队分工情况？这样我们能更有针对性地进行讨论。我也会准备好针对您业务场景的定制化方案初稿。', '关键: 细致周到，展现专业。']",
            '3',
            '1',
            'admin',
            NOW(),
            0
        );

        
2025-07-06 10:31:30 - utils - INFO - create_role:150 - 通知发送成功
2025-07-06 10:31:30 - utils - INFO - create_role:156 - 角色创建完成 - 租户ID: 1, 任务ID: 18, 策略ID: 8
2025-07-06 10:31:30 - utils - INFO - create_role_background:169 - 后台角色创建任务完成 - 租户ID: 1, 任务ID: 18
2025-07-06 10:31:30 - api - INFO - process_role_creation_background:59 - 角色创建任务执行完成 - 请求ID: 927df576-3e9c-47e0-8239-7eb551cf551f
2025-07-06 11:08:55 - main - INFO - process_user_input:152 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 11:08:55 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 11:08:55 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '777777', 'timestamp': '2025-07-06 11:08:51'}]
2025-07-06 11:08:55 - main - ERROR - process_agent_background:126 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: (pymysql.err.OperationalError) (2006, "MySQL server has gone away (TimeoutError(110, 'Connection timed out'))")
[SQL: SELECT sessions.app_name AS sessions_app_name, sessions.user_id AS sessions_user_id, sessions.id AS sessions_id, sessions.state AS sessions_state, sessions.create_time AS sessions_create_time, sessions.update_time AS sessions_update_time 
FROM sessions 
WHERE sessions.app_name = %(pk_1)s AND sessions.user_id = %(pk_2)s AND sessions.id = %(pk_3)s]
[parameters: {'pk_1': 'ai_sales_agent', 'pk_2': '18', 'pk_3': 'wxid_h5nwnc84f0di22'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 806, in _write_bytes
    self._sock.sendall(data)
TimeoutError: [Errno 110] Connection timed out

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 864, in _execute_command
    self._write_bytes(packet)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 809, in _write_bytes
    raise err.OperationalError(
pymysql.err.OperationalError: (2006, "MySQL server has gone away (TimeoutError(110, 'Connection timed out'))")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 114, in call_agent_async
    session = await runner.session_service.get_session(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 367, in get_session
    storage_session = session_factory.get(
                      ^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3694, in get
    return self._get_impl(
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3874, in _get_impl
    return db_load_fn(
           ^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 694, in load_on_pk_identity
    session.execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2251, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1416, in execute
    return meth(
           ^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 864, in _execute_command
    self._write_bytes(packet)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 809, in _write_bytes
    raise err.OperationalError(
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (2006, "MySQL server has gone away (TimeoutError(110, 'Connection timed out'))")
[SQL: SELECT sessions.app_name AS sessions_app_name, sessions.user_id AS sessions_user_id, sessions.id AS sessions_id, sessions.state AS sessions_state, sessions.create_time AS sessions_create_time, sessions.update_time AS sessions_update_time 
FROM sessions 
WHERE sessions.app_name = %(pk_1)s AND sessions.user_id = %(pk_2)s AND sessions.id = %(pk_3)s]
[parameters: {'pk_1': 'ai_sales_agent', 'pk_2': '18', 'pk_3': 'wxid_h5nwnc84f0di22'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-06 11:08:55 - main - ERROR - process_agent_background:146 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: send_chat() missing 1 required positional argument: 'belong_chat_id'
2025-07-06 11:09:59 - main - INFO - process_user_input:152 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 11:09:59 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 11:09:59 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 11:10:00 - utils.chat - INFO - call_agent_async:123 - 创建新会话: wxid_h5nwnc84f0di22 for user: 18
2025-07-06 11:10:00 - main - ERROR - process_agent_background:126 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:09:56'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 144, in call_agent_async
    content = types.Content(role='user', parts=[types.Part(text=query)])
                                                ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:09:56'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-06 11:10:00 - main - ERROR - process_agent_background:146 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: send_chat() missing 1 required positional argument: 'belong_chat_id'
2025-07-06 11:10:13 - main - INFO - process_user_input:152 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 11:10:13 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 11:10:13 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '888', 'timestamp': '2025-07-06 11:10:01'}, {'type': 'text', 'content': '777', 'timestamp': '2025-07-06 11:10:06'}, {'type': 'text', 'content': '444', 'timestamp': '2025-07-06 11:10:10'}]
2025-07-06 11:10:13 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 11:10:13 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751771413' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '888', 'timestamp': '2025-07-06 11:10:01'}, {'type': 'text', 'content': '777', 'timestamp': '2025-07-06 11:10:06'}, {'type': 'text', 'content': '444', 'timestamp': '2025-07-06 11:10:10'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='rb5Y3p48' timestamp=1751771413.9535096 to session wxid_h5nwnc84f0di22
2025-07-06 11:10:14 - main - ERROR - process_agent_background:126 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:10:10'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 144, in call_agent_async
    content = types.Content(role='user', parts=[types.Part(text=query)])
                                                ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:10:10'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-06 11:10:14 - main - ERROR - process_agent_background:146 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: send_chat() missing 1 required positional argument: 'belong_chat_id'
2025-07-06 12:09:53 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:09:58 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:09:58 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:09:58 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:09:58 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:09:58 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:09:58 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:09:58 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:10:00 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:11:07 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:11:12 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:11:12 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:11:12 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:11:12 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:11:12 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:11:12 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:11:12 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:11:14 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:16:46 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:16:46 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:16:46 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dcb423ff63324aa1980afbecc8d01d96.jpg', 'timestamp': '2025-07-06 12:16:42'}]
2025-07-06 12:16:46 - utils.chat - INFO - call_agent_async:123 - 创建新会话: wxid_71rpc0hw5pj021 for user: 18
2025-07-06 12:16:47 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dcb423ff63324aa1980afbecc8d01d96.jpg', 'timestamp': '2025-07-06 12:16:42'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-db11c2c9-89bd-4e68-878a-c169d1c92ad9' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='Bxhnb6KO' timestamp=1751775407.202993 to session wxid_71rpc0hw5pj021
2025-07-06 12:16:47 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:16:47 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:18:00 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:18:00 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:18:00 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '[疑问]', 'timestamp': '2025-07-06 12:17:56'}]
2025-07-06 12:18:00 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:18:00 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751775480' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'text', 'content': '[疑问]', 'timestamp': '2025-07-06 12:17:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='hSaJywKi' timestamp=1751775480.8942962 to session wxid_71rpc0hw5pj021
2025-07-06 12:18:01 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '[疑问]', 'timestamp': '2025-07-06 12:17:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-0f8704a7-160a-45e3-ac0b-23823bbbab7e' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='qll7q3f4' timestamp=1751775481.55976 to session wxid_71rpc0hw5pj021
2025-07-06 12:18:02 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:18:02 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:18:02 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:20:43 - main - INFO - process_user_input:154 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 12:20:43 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 12:20:43 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 12:20:43 - utils.chat - INFO - call_agent_async:123 - 创建新会话: 1234 for user: 67
2025-07-06 12:20:44 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-e8ae136b-e8f1-47a4-976d-0e9b488228d2' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='ZvDYPWYs' timestamp=1751775644.380784 to session 1234
2025-07-06 12:20:44 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:20:44 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:24:45 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:24:50 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:24:50 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:24:50 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:24:50 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:24:50 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:24:50 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:24:50 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:24:52 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:25:30 - main - INFO - process_user_input:154 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 12:25:30 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 12:25:30 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 12:25:31 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 12:25:31 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751775931' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='PLCeLPnA' timestamp=1751775931.219671 to session 1234
2025-07-06 12:25:31 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-5c0bec27-157b-4ddd-a258-4766085c725a' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='gN7ETYIa' timestamp=1751775931.855946 to session 1234
2025-07-06 12:25:32 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 12:25:32 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:25:32 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:26:59 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:26:59 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:26:59 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '555', 'timestamp': '2025-07-06 12:26:50'}, {'type': 'text', 'content': '555', 'timestamp': '2025-07-06 12:26:55'}]
2025-07-06 12:27:00 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 12:27:00 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751776020' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '555', 'timestamp': '2025-07-06 12:26:50'}, {'type': 'text', 'content': '555', 'timestamp': '2025-07-06 12:26:55'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='l6k90qNp' timestamp=1751776020.0918145 to session wxid_h5nwnc84f0di22
2025-07-06 12:27:00 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '555', 'timestamp': '2025-07-06 12:26:50'}, {'type': 'text', 'content': '555', 'timestamp': '2025-07-06 12:26:55'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-b06f6bfc-c25c-4f00-bce9-091961b7c984' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='PUK4Hoh6' timestamp=1751776020.716706 to session wxid_h5nwnc84f0di22
2025-07-06 12:27:01 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: l6k90qNp
2025-07-06 12:27:01 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rb5Y3p48
2025-07-06 12:27:01 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:27:01 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:27:09 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:27:09 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:27:09 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '2222', 'timestamp': '2025-07-06 12:27:04'}]
2025-07-06 12:27:09 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 12:27:09 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751776029' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '2222', 'timestamp': '2025-07-06 12:27:04'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='sqQFfSug' timestamp=1751776029.3065498 to session wxid_h5nwnc84f0di22
2025-07-06 12:27:09 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '2222', 'timestamp': '2025-07-06 12:27:04'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-7ab5c54a-e5be-4b9c-8a6f-1cdc2284935f' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='gTLodJZH' timestamp=1751776029.929159 to session wxid_h5nwnc84f0di22
2025-07-06 12:27:10 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: sqQFfSug
2025-07-06 12:27:10 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: l6k90qNp
2025-07-06 12:27:10 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rb5Y3p48
2025-07-06 12:27:10 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:27:10 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:27:50 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:28:21 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:28:21 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:28:21 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/6cb02f6546e64785aed27df54d2de4c8.png', 'timestamp': '2025-07-06 12:28:16'}]
2025-07-06 12:28:21 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:28:21 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751776101' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/6cb02f6546e64785aed27df54d2de4c8.png', 'timestamp': '2025-07-06 12:28:16'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='oQ6facOy' timestamp=1751776101.3543293 to session wxid_71rpc0hw5pj021
2025-07-06 12:28:22 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/6cb02f6546e64785aed27df54d2de4c8.png', 'timestamp': '2025-07-06 12:28:16'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-b367a1f1-a776-4ce6-a3fe-b7f0eebf69d4' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='YsL5cti6' timestamp=1751776102.004537 to session wxid_71rpc0hw5pj021
2025-07-06 12:28:22 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:28:22 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:28:22 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:28:22 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:28:43 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:28:43 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:28:43 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/72a19972fb594ad7863b89fdd4b69ae4.png', 'timestamp': '2025-07-06 12:28:38'}]
2025-07-06 12:28:43 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:28:43 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751776123' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/72a19972fb594ad7863b89fdd4b69ae4.png', 'timestamp': '2025-07-06 12:28:38'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='J32Dk3Dm' timestamp=1751776123.5133164 to session wxid_71rpc0hw5pj021
2025-07-06 12:28:44 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/72a19972fb594ad7863b89fdd4b69ae4.png', 'timestamp': '2025-07-06 12:28:38'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-6913a709-cb18-47e7-be8a-df9e1100587a' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='qgRqMyDP' timestamp=1751776124.150487 to session wxid_71rpc0hw5pj021
2025-07-06 12:28:44 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:28:44 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:28:44 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:28:44 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:28:44 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:29:32 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:29:46 - main - INFO - process_user_input:154 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 12:29:46 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 12:29:46 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 12:29:46 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 12:29:46 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751776186' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='y34m15eT' timestamp=1751776186.289622 to session 1234
2025-07-06 12:29:46 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-d95bc153-7a17-4d86-98f2-dbd4eee47072' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='0jBUoZUb' timestamp=1751776186.930488 to session 1234
2025-07-06 12:29:47 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 12:29:47 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 12:29:47 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:29:47 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:32:14 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:32:14 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:32:14 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '[再见]', 'timestamp': '2025-07-06 12:32:09'}]
2025-07-06 12:32:14 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:32:14 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751776334' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'text', 'content': '[再见]', 'timestamp': '2025-07-06 12:32:09'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='IVenTcAM' timestamp=1751776334.3456233 to session wxid_71rpc0hw5pj021
2025-07-06 12:32:14 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '[再见]', 'timestamp': '2025-07-06 12:32:09'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-18c687ef-fedd-4ca0-bb7b-0cc7b42065bd' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='I8vTWYXF' timestamp=1751776334.97913 to session wxid_71rpc0hw5pj021
2025-07-06 12:32:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:32:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:32:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:32:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:32:15 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:32:15 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:32:27 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:32:27 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:32:27 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/b5d7c4ebf155464d88e39a92507f8483.jpg', 'timestamp': '2025-07-06 12:32:22'}]
2025-07-06 12:32:27 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:32:27 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751776347' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/b5d7c4ebf155464d88e39a92507f8483.jpg', 'timestamp': '2025-07-06 12:32:22'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='SDVDqA3w' timestamp=1751776347.6935616 to session wxid_71rpc0hw5pj021
2025-07-06 12:32:28 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/b5d7c4ebf155464d88e39a92507f8483.jpg', 'timestamp': '2025-07-06 12:32:22'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-9dea77e1-72d9-4ada-9c64-4873657c8bbb' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='c1zA68AR' timestamp=1751776348.322288 to session wxid_71rpc0hw5pj021
2025-07-06 12:32:28 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:32:28 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:32:28 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:32:28 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:32:28 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:32:28 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:32:28 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:33:37 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:33:37 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:33:37 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/557d1e986eae4299aee7a6b284f97da6.png', 'timestamp': '2025-07-06 12:33:32'}]
2025-07-06 12:33:37 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:33:37 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751776417' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/557d1e986eae4299aee7a6b284f97da6.png', 'timestamp': '2025-07-06 12:33:32'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='h1lph3HD' timestamp=1751776417.496472 to session wxid_71rpc0hw5pj021
2025-07-06 12:33:38 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/557d1e986eae4299aee7a6b284f97da6.png', 'timestamp': '2025-07-06 12:33:32'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-3968a4fc-5544-4d23-a54e-5abbabfcf60c' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='VuX28KYJ' timestamp=1751776418.132284 to session wxid_71rpc0hw5pj021
2025-07-06 12:33:38 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:33:38 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:33:38 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:33:38 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:33:38 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:33:38 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:33:38 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:33:38 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:34:38 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:34:43 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:34:43 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:34:43 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:34:43 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:34:43 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:34:43 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:34:44 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:34:46 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:34:54 - main - INFO - process_user_input:154 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 12:34:54 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 12:34:54 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 12:34:54 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 12:34:54 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751776494' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='CyajgLsn' timestamp=1751776494.771557 to session 1234
2025-07-06 12:34:55 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-87fc84cc-1515-4bfc-9986-637d17aa3561' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='KaetF8r7' timestamp=1751776495.422083 to session 1234
2025-07-06 12:34:55 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: CyajgLsn
2025-07-06 12:34:55 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 12:34:55 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 12:34:55 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:34:58 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:34:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:34:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:34:58 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=45, candidates_tokens_details=None, prompt_token_count=1392, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1437, traffic_type=None) invocation_id='e-87fc84cc-1515-4bfc-9986-637d17aa3561' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='d7fDjwAI' timestamp=1751776495.859413 to session 1234
2025-07-06 12:34:58 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}
]
2025-07-06 12:34:58 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 67, session_id: 1234
2025-07-06 12:34:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:34:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:34:58 - main - ERROR - process_agent_background:121 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:34:58 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:40:38 - main - INFO - process_user_input:154 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:40:38 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:40:38 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '嘎嘎', 'timestamp': '2025-07-06 12:40:34'}]
2025-07-06 12:40:38 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:40:38 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751776838' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'text', 'content': '嘎嘎', 'timestamp': '2025-07-06 12:40:34'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='RMKlezeC' timestamp=1751776838.8285174 to session wxid_71rpc0hw5pj021
2025-07-06 12:40:39 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '嘎嘎', 'timestamp': '2025-07-06 12:40:34'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='gNu4vb1r' timestamp=1751776839.473304 to session wxid_71rpc0hw5pj021
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:40:39 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:40:39 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:40:43 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:40:43 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:40:43 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:40:43 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_88da9998484a4b6d850e6d', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dcb423ff63324aa1980afbecc8d01d96.jpg'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=64, candidates_tokens_details=None, prompt_token_count=1755, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1819, traffic_type=None) invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='ePwjbyAn' timestamp=1751776839.905933 to session wxid_71rpc0hw5pj021
2025-07-06 12:40:48 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:40:48 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_88da9998484a4b6d850e6d', name='image_comprehension', response={'status': 'success', 'image_description': '这张图片展示了一段微信聊天记录的截图。具体内容如下：\n\n1. **左侧消息**：\n   - 时间：10:06\n   - 发送者头像：一个海滩背景的图案，上面有两只猫。\n   - 消息内容：辉辉聊客户现在没建立连接了，接收不到消息，你有空看看哈。\n\n2. **右侧消息**：\n   - 第一条消息：绿色背景，白色字体，内容为“我知道了”，旁边有一个猫咪的表情包。\n   - 第二条消息：绿色背景，白色字体，内容为“后端部署的问题”，旁边也有一个猫咪的表情包。\n\n从对话内容来看，左侧的消息表明某个名为“辉辉聊”的客户当前无法建立连接，导致无法接收消息，并请求对方查看一下问题。右侧的消息回复表示知道了，并推测问题是与后端部署相关的。\n\n总体来说，这张图片描绘的是一个关于技术问题的沟通场景，涉及到客户的连接问题和可能的后端部署问题。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='6TDiGQM5' timestamp=1751776848.45495 to session wxid_71rpc0hw5pj021
2025-07-06 12:40:48 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:40:48 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:40:48 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:40:52 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:40:52 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:40:52 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:40:52 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_9c28a897a2754c3ba56b71', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/6cb02f6546e64785aed27df54d2de4c8.png'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=68, candidates_tokens_details=None, prompt_token_count=3301, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=3369, traffic_type=None) invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='gIJskT0x' timestamp=1751776848.891359 to session wxid_71rpc0hw5pj021
2025-07-06 12:40:55 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:40:55 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_9c28a897a2754c3ba56b71', name='image_comprehension', response={'status': 'success', 'image_description': '图中显示的是一个消息界面的一部分。具体来说，这是一个聊天应用中的消息气泡。左侧的绿色气泡中显示了数字“2”，右侧的白色气泡中有一张猫的照片，并且有一个扬声器图标，表示这条消息可能包含语音信息或音频附件。\n\n这个界面通常用于展示聊天应用中的消息内容和状态。绿色气泡通常代表发送的消息，而白色气泡则代表接收的消息。扬声器图标表明这条消息可能是通过语音录制发送的，或者是包含语音附件的消息。猫的照片则表明这条消息的内容可能与这只猫有关，可能是用户分享的一张照片或者是一条关于猫的信息。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='iD2I2zC7' timestamp=1751776855.502146 to session wxid_71rpc0hw5pj021
2025-07-06 12:40:55 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:40:55 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:40:55 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:41:00 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:41:00 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:00 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:00 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_74b990f71dfc45268c88f2', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/72a19972fb594ad7863b89fdd4b69ae4.png'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=69, candidates_tokens_details=None, prompt_token_count=4510, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=4579, traffic_type=None) invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='BOsVjIGM' timestamp=1751776855.934377 to session wxid_71rpc0hw5pj021
2025-07-06 12:41:03 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:41:03 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_74b990f71dfc45268c88f2', name='image_comprehension', response={'status': 'success', 'image_description': '这张图片展示了一个个人资料页面的截图。页面上有一个头像，头像是一个白色的猫咪。以下是页面上的信息：\n\n- 用户名：u\n- 个人信息：\n  - 行业：-\n  - 部门：-\n  - 公司：-\n  - 岗位：-\n  - 规模：-\n  - 所在城市：吉安\n\n从这些信息来看，这个页面显示的是一个用户的基本资料，但没有提供具体的工作或职业信息。页面背景是浅紫色，整体设计简洁明了。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='G33YJfOW' timestamp=1751776863.686289 to session wxid_71rpc0hw5pj021
2025-07-06 12:41:04 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:04 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:41:04 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:41:08 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:41:08 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:08 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:08 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_c8532782cdf3423db2c3c3', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/b5d7c4ebf155464d88e39a92507f8483.jpg'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=71, candidates_tokens_details=None, prompt_token_count=5283, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=5354, traffic_type=None) invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='dSU9NEJ2' timestamp=1751776864.1172 to session wxid_71rpc0hw5pj021
2025-07-06 12:41:12 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:41:12 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_c8532782cdf3423db2c3c3', name='image_comprehension', response={'status': 'success', 'image_description': '图中描绘了一位身穿黑色服装的人物，手持一把武士刀。人物的侧脸朝向画面右侧，头发扎成一个高高的发髻，部分头发散落在额前。她的手臂上纹有复杂的图案，包括一些动物和植物的纹身设计。背景是灰色的，整体色调较为阴沉，给人一种神秘和冷峻的感觉。\n\n从这些细节来看，这幅图像可能传达出一种武侠或暗黑风格的主题。人物的姿态和装备（武士刀）暗示了她可能是一个战士或剑客的形象，而纹身则可能象征着她的个性、经历或身份。整体氛围显得既强大又有些孤独，可能是在表达一种内心的强大与冷静。这种风格在视觉艺术和影视作品中经常被用来塑造角色的神秘感和力量感。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='uAgpRp0I' timestamp=1751776872.103771 to session wxid_71rpc0hw5pj021
2025-07-06 12:41:12 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:12 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:41:12 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:41:17 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:41:17 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:17 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:17 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_045b566467004f7088aaf2', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/557d1e986eae4299aee7a6b284f97da6.png'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=70, candidates_tokens_details=None, prompt_token_count=6588, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=6658, traffic_type=None) invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='3NiNNCvh' timestamp=1751776872.532259 to session wxid_71rpc0hw5pj021
2025-07-06 12:41:23 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:41:23 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_045b566467004f7088aaf2', name='image_comprehension', response={'status': 'success', 'image_description': '这张图片展示的是一个网页开发者工具的网络性能分析界面。具体来说，这是在浏览器的开发者工具中打开的“网络”标签页，用于监控和分析网页请求的详细信息。\n\n以下是对图片的详细解释：\n\n1. **界面布局**：\n   - **顶部导航栏**：包含多个选项卡，如“元素”、“控制台”、“源代码/来源”、“网络”、“性能”、“内存”、“应用”、“隐私与安全”、“Lighthouse”、“记录器”和“Redux”。当前选中的选项卡是“网络”。\n   - **过滤器**：左侧有一个过滤器区域，可以设置过滤条件，例如保留日志、停用缓存等。\n   - **请求列表**：右侧显示了具体的网络请求详情，包括请求的时间范围（5 ms到40 ms）和请求的名称。\n\n2. **请求详情**：\n   - **请求名称**：图中显示的请求名称是 `listAiAddWechat`。\n   - **请求时间**：请求的时间范围从5 ms到35 ms不等，表明请求的响应时间在短时间内波动。\n   - **请求参数**：在“载荷”标签下，可以看到请求的参数信息：\n     - `weChatNickname: ""`\n     - `taskIds: [44]`\n\n3. **请求内容**：\n   - **请求头**：虽然没有直接显示在图中，但通常会出现在开发者工具的其他部分。\n   - **预览**：显示了请求的数据结构，包括 `weChatNickname` 和 `taskIds` 两个字段。\n   - **响应**：这部分通常会在请求完成后显示服务器返回的数据，但由于图中只展示了请求的部分信息，没有显示响应内容。\n\n4. **性能分析**：\n   - 图片中绿色的进度条表示请求的加载时间，从5 ms到35 ms，说明这个请求的响应时间在短时间内完成。\n   - 时间轴上的刻度可以帮助开发者理解请求的具体延迟情况。\n\n总体来说，这张图片展示了使用浏览器开发者工具分析网络请求的过程，帮助开发者了解请求的执行时间和参数信息，从而优化网页性能。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='sZMSIojh' timestamp=1751776883.754891 to session wxid_71rpc0hw5pj021
2025-07-06 12:41:24 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:41:24 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:41:24 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:42:58 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:42:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:42:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:42:58 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dcb423ff63324aa1980afbecc8d01d96.jpg", "content": "这张图片展示了一段微信聊天记录的截图。具体内容如下：\\n\\n1. **左侧消息**：\\n   - 时间：10:06\\n   - 发送者头像：一个海浪背景的图案，上面有两只猫。\\n   - 消息内容：辉辉聊客户现在没建立连接了，接收不到消息，你有空看看哈。\\n\\n2. **右侧消息**：\\n   - 第一条消息：绿色背景，白色字体，内容为“我知道了”，旁边有一个猫咪的表情包。\\n   - 第二条消息：绿色背景，白色字体，内容为“后端部署的问题”，旁边也有一个猫咪的表情包。\\n\\n从对话内容来看，左侧的消息表明某个名为“辉辉聊”的客户当前无法建立连接，导致无法接收消息，并请求对方查看一下问题。右侧的消息回复表示知道了，并推测问题是与后端部署相关的。\\n\\n总体来说，这张图片描绘的是一个关于技术问题的沟通场景，涉及到客户的连接问题和可能的后端部署问题。", "timestamp": "2025-07-06 12:16:42"},\n    {"type": "text", "content": "[疑问]", "timestamp": "2025-07-06 12:17:56"},\n    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/6cb02f6546e64785aed27df54d2de4c8.png", "content": "图中显示的是一个消息界面的一部分。具体来说，这是一个聊天应用中的消息气泡。左侧的绿色气泡中显示了数字“2”，右侧的白色气泡中有一张猫的照片，并且有一个扬声器图标，表示这条消息可能包含语音信息或音频附件。\\n\\n这个界面通常用于展示聊天应用中的消息内容和状态。绿色气泡通常代表发送的消息，而白色气泡则代表接收的消息。扬声器图标表明这条消息可能是通过语音录制发送的，或者是包含语音附件的消息。猫的照片则表明这条消息的内容可能与这只猫有关，可能是用户分享的一张照片或者是一条关于猫的信息。", "timestamp": "2025-07-06 12:28:16"},\n    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/72a19972fb594ad7863b89fdd4b69ae4.png", "content": "这张图片展示了一个个人资料页面的截图。页面上有一个头像，头像是一个白色的猫咪。以下是页面上的信息：\\n\\n- 用户名：u\\n- 个人信息：\\n  - 行业：-\\n  - 部门：-\\n  - 公司：-\\n  - 岗位：-\\n  - 规模：-\\n  - 所在城市：吉林\\n\\n从这些信息来看，这个页面显示的是一个用户的基本资料，但没有提供具体的工作或职业信息。页面背景是浅紫色，整体设计简洁明了。", "timestamp": "2025-07-06 12:28:38"},\n    {"type": "text", "content": "[再见]", "timestamp": "2025-07-06 12:32:09"},\n    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/b5d7c4ebf155464d88e39a92507f8483.jpg", "content": "图中描绘了一位身穿黑色服装的人物，手持一把武士刀。人物的侧脸朝向画面右侧，头发扎成一个高高的发髻，部分头发散落在额前。她的手臂上有复杂的图案，包括一些动物和植物的纹身设计。背景是灰色的，整体色调较为阴沉，给人一种神秘和冷冽的感觉。\\n\\n从这些细节来看，这幅图像可能传达出一种武士或暗黑风格的主题。人物的姿态和装备（武士刀）暗示了她可能是一个战士或剑客的形象，而纹身则可能象征着她的个性、经历或身份。整体氛围显得既强大又有些建独，可能是在表达一种内心的强大力量与冷静。这种风格在视觉艺术和影视作品中经常被用来塑造角色的神秘感和力量感。", "timestamp": "2025-07-06 12:32:22"},\n    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/557d1e986eae4299aee7a6b284f97da6.png", "content": "这张图片展示的是一个网页开发者工具的网络性能分析界面。具体来说，这是在浏览器的开发者工具中打开的“网络”标签页，用于监控和分析网页请求的详细信息。\\n\\n以下是对于图片的详细解释：\\n\\n1. **界面布局**：\\n   - **顶部导航栏**：包含多个选项卡，如“元素”、“控制台”、“源代码/来源”、“网络”、“性能”、“内存”、“应用”、“隐私与安全”、“Lighthouse”、“记录器”和“Redux”。当前选中的选项卡是“网络”。\\n   - **过滤器**：左侧有一个过滤器区域，可以设置过滤条件，例如保留日志、停用缓存等。\\n   - **请求列表**：右侧显具体示了网络请求详情，包括请求的时间范围（5 ms到40 ms）和请求的名称。\\n\\n2. **请求详情**：\\n   - **请求名称**：图中显示的请求名称是 `listAiAddWechat`。\\n   - **请求时间**：请求的时间范围从5 ms到35 ms不等，表明请求的响应时间在短时间内波动。\\n   - **请求参数**：在“载荷”标签下，可以看到请求的参数信息：\\n     - `weChatNickname: \\"\\"`\\n     - `taskIds: [44]`\\n\\n3. **请求内容**：\\n   - **请求头**：虽然没有直接显示在图中，但通常会出现在开发者工具的其他部分。\\n   - **预览**：显示了请求的数据结构，包括 `weChatNickname` 和 `taskIds` 两个字段。\\n   - **响应**：这部分通常会在请求完成后显示服务器返回的数据，但由于图中只展示了请求的部分信息，没有显示响应内容。\\n\\n4. **性能分析**：\\n   - 图片中绿色的进度条表示请求的加载时间，从5 ms到35 ms，说明这个请求的响应时间在短时间内容完成。\\n   - 时间轴上的刻度可以帮助开发者理解请求的具体延迟情况。\\n\\n总体来说，这张图片展示了使用浏览器开发者工具分析网络请求的过程，帮助开发者了解请求的执行时间和参数信息，从而优化网页性能。", "timestamp": "2025-07-06 12:33:32"},\n    {"type": "text", "content": "嘎嘎", "timestamp": "2025-07-06 12:40:34"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=1715, candidates_tokens_details=None, prompt_token_count=9556, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=11271, traffic_type=None) invocation_id='e-c0ad81c6-6208-4ae4-b37f-0f50e9e34696' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='aTOItvA0' timestamp=1751776884.185007 to session wxid_71rpc0hw5pj021
2025-07-06 12:42:58 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dcb423ff63324aa1980afbecc8d01d96.jpg", "content": "这张图片展示了一段微信聊天记录的截图。具体内容如下：\n\n1. **左侧消息**：\n   - 时间：10:06\n   - 发送者头像：一个海浪背景的图案，上面有两只猫。\n   - 消息内容：辉辉聊客户现在没建立连接了，接收不到消息，你有空看看哈。\n\n2. **右侧消息**：\n   - 第一条消息：绿色背景，白色字体，内容为“我知道了”，旁边有一个猫咪的表情包。\n   - 第二条消息：绿色背景，白色字体，内容为“后端部署的问题”，旁边也有一个猫咪的表情包。\n\n从对话内容来看，左侧的消息表明某个名为“辉辉聊”的客户当前无法建立连接，导致无法接收消息，并请求对方查看一下问题。右侧的消息回复表示知道了，并推测问题是与后端部署相关的。\n\n总体来说，这张图片描绘的是一个关于技术问题的沟通场景，涉及到客户的连接问题和可能的后端部署问题。", "timestamp": "2025-07-06 12:16:42"},
    {"type": "text", "content": "[疑问]", "timestamp": "2025-07-06 12:17:56"},
    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/6cb02f6546e64785aed27df54d2de4c8.png", "content": "图中显示的是一个消息界面的一部分。具体来说，这是一个聊天应用中的消息气泡。左侧的绿色气泡中显示了数字“2”，右侧的白色气泡中有一张猫的照片，并且有一个扬声器图标，表示这条消息可能包含语音信息或音频附件。\n\n这个界面通常用于展示聊天应用中的消息内容和状态。绿色气泡通常代表发送的消息，而白色气泡则代表接收的消息。扬声器图标表明这条消息可能是通过语音录制发送的，或者是包含语音附件的消息。猫的照片则表明这条消息的内容可能与这只猫有关，可能是用户分享的一张照片或者是一条关于猫的信息。", "timestamp": "2025-07-06 12:28:16"},
    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/72a19972fb594ad7863b89fdd4b69ae4.png", "content": "这张图片展示了一个个人资料页面的截图。页面上有一个头像，头像是一个白色的猫咪。以下是页面上的信息：\n\n- 用户名：u\n- 个人信息：\n  - 行业：-\n  - 部门：-\n  - 公司：-\n  - 岗位：-\n  - 规模：-\n  - 所在城市：吉林\n\n从这些信息来看，这个页面显示的是一个用户的基本资料，但没有提供具体的工作或职业信息。页面背景是浅紫色，整体设计简洁明了。", "timestamp": "2025-07-06 12:28:38"},
    {"type": "text", "content": "[再见]", "timestamp": "2025-07-06 12:32:09"},
    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/b5d7c4ebf155464d88e39a92507f8483.jpg", "content": "图中描绘了一位身穿黑色服装的人物，手持一把武士刀。人物的侧脸朝向画面右侧，头发扎成一个高高的发髻，部分头发散落在额前。她的手臂上有复杂的图案，包括一些动物和植物的纹身设计。背景是灰色的，整体色调较为阴沉，给人一种神秘和冷冽的感觉。\n\n从这些细节来看，这幅图像可能传达出一种武士或暗黑风格的主题。人物的姿态和装备（武士刀）暗示了她可能是一个战士或剑客的形象，而纹身则可能象征着她的个性、经历或身份。整体氛围显得既强大又有些建独，可能是在表达一种内心的强大力量与冷静。这种风格在视觉艺术和影视作品中经常被用来塑造角色的神秘感和力量感。", "timestamp": "2025-07-06 12:32:22"},
    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/557d1e986eae4299aee7a6b284f97da6.png", "content": "这张图片展示的是一个网页开发者工具的网络性能分析界面。具体来说，这是在浏览器的开发者工具中打开的“网络”标签页，用于监控和分析网页请求的详细信息。\n\n以下是对于图片的详细解释：\n\n1. **界面布局**：\n   - **顶部导航栏**：包含多个选项卡，如“元素”、“控制台”、“源代码/来源”、“网络”、“性能”、“内存”、“应用”、“隐私与安全”、“Lighthouse”、“记录器”和“Redux”。当前选中的选项卡是“网络”。\n   - **过滤器**：左侧有一个过滤器区域，可以设置过滤条件，例如保留日志、停用缓存等。\n   - **请求列表**：右侧显具体示了网络请求详情，包括请求的时间范围（5 ms到40 ms）和请求的名称。\n\n2. **请求详情**：\n   - **请求名称**：图中显示的请求名称是 `listAiAddWechat`。\n   - **请求时间**：请求的时间范围从5 ms到35 ms不等，表明请求的响应时间在短时间内波动。\n   - **请求参数**：在“载荷”标签下，可以看到请求的参数信息：\n     - `weChatNickname: \"\"`\n     - `taskIds: [44]`\n\n3. **请求内容**：\n   - **请求头**：虽然没有直接显示在图中，但通常会出现在开发者工具的其他部分。\n   - **预览**：显示了请求的数据结构，包括 `weChatNickname` 和 `taskIds` 两个字段。\n   - **响应**：这部分通常会在请求完成后显示服务器返回的数据，但由于图中只展示了请求的部分信息，没有显示响应内容。\n\n4. **性能分析**：\n   - 图片中绿色的进度条表示请求的加载时间，从5 ms到35 ms，说明这个请求的响应时间在短时间内容完成。\n   - 时间轴上的刻度可以帮助开发者理解请求的具体延迟情况。\n\n总体来说，这张图片展示了使用浏览器开发者工具分析网络请求的过程，帮助开发者了解请求的执行时间和参数信息，从而优化网页性能。", "timestamp": "2025-07-06 12:33:32"},
    {"type": "text", "content": "嘎嘎", "timestamp": "2025-07-06 12:40:34"}
]
2025-07-06 12:42:58 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:42:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:42:58 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:42:58 - main - ERROR - process_agent_background:121 - 发送通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:42:58 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-36' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:44:21 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:44:26 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:44:26 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:44:26 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:44:26 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:44:26 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:44:26 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:44:26 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:44:33 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:45:44 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:45:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:45:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:45:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:45:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:45:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:45:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:45:49 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:45:56 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:46:07 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:07 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:07 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/e7d009d01720451e8499830bb58a75a5.png', 'timestamp': '2025-07-06 12:46:02'}]
2025-07-06 12:46:07 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:46:07 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777167' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/e7d009d01720451e8499830bb58a75a5.png', 'timestamp': '2025-07-06 12:46:02'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='vS7lZIqm' timestamp=1751777167.7794995 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:08 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/e7d009d01720451e8499830bb58a75a5.png', 'timestamp': '2025-07-06 12:46:02'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-3cc740d0-9e71-452b-878a-5e314a868d44' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='DYYkuNwm' timestamp=1751777168.408181 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:46:08 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:46:08 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:46:14 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:46:14 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:14 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:14 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_a26a1e0a74bc40b3a7cef3', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/e7d009d01720451e8499830bb58a75a5.png'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=69, candidates_tokens_details=None, prompt_token_count=11367, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=11436, traffic_type=None) invocation_id='e-3cc740d0-9e71-452b-878a-5e314a868d44' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='J6ueP3W8' timestamp=1751777168.823039 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:18 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:46:18 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_a26a1e0a74bc40b3a7cef3', name='image_comprehension', response={'status': 'success', 'image_description': '图中展示的是一个用户界面的截图，具体来说是一个销售任务管理的页面。以下是对图片的详细描述：\n\n1. **标题区域**：\n   - 页面顶部有一个标题栏，标题栏上写着“全部销售任务”，并有一个向上的箭头图标，表示可以展开或折叠该部分的内容。\n\n2. **内容区域**：\n   - 在标题栏下方，有一个矩形框，框内显示了具体的销售任务信息。\n   - 矩形框内有两条记录：\n     - 第一条记录是“全部销售任务”，旁边有一个勾选符号（√），表示这条任务已经被标记为完成。\n     - 第二条记录是“未执行销售任务”，但没有进一步的信息或其他标记。\n\n3. **背景和颜色**：\n   - 整个界面使用了浅紫色和白色作为主要配色方案，给人一种简洁明了的感觉。\n   - 标题栏和矩形框之间有一条红色的边框线，可能用于区分不同的功能区域。\n\n4. **其他元素**：\n   - 在矩形框的最底部，可以看到“999系统套餐”的字样，这可能是页面的底部导航或其他相关链接。\n\n总体来看，这个界面主要用于展示和管理用户的销售任务状态，通过勾选符号来标识已完成的任务，并提供未执行任务的列表。这种设计有助于用户快速了解当前的销售任务情况，并进行相应的管理和跟进。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-3cc740d0-9e71-452b-878a-5e314a868d44' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='blSGp0gX' timestamp=1751777178.802963 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:19 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:19 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:46:19 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:46:20 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:20 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:20 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/495b8432607543788fb488b306d39b77.png', 'timestamp': '2025-07-06 12:46:16'}]
2025-07-06 12:46:20 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:46:20 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777180' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/495b8432607543788fb488b306d39b77.png', 'timestamp': '2025-07-06 12:46:16'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='EIERtIHG' timestamp=1751777180.8727558 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:21 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/495b8432607543788fb488b306d39b77.png', 'timestamp': '2025-07-06 12:46:16'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c89eb1c9-b479-46e6-94f4-e239323ae3c9' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='B1J3c1vE' timestamp=1751777181.486992 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:46:21 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:46:21 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:46:25 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:46:25 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:25 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:25 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_4a8fa9f158744e7f8eec9d', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/495b8432607543788fb488b306d39b77.png'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=70, candidates_tokens_details=None, prompt_token_count=13648, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=13718, traffic_type=None) invocation_id='e-c89eb1c9-b479-46e6-94f4-e239323ae3c9' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='diFSZYyl' timestamp=1751777181.904879 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:28 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:46:28 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_4a8fa9f158744e7f8eec9d', name='image_comprehension', response={'status': 'success', 'image_description': '图中显示的是一个语音输入或语音识别的界面。具体来说：\n\n1. 左上角有一个小圆形头像，里面有一只猫的图片。\n2. 中间是一个绿色的椭圆形按钮，按钮上有“2s”的字样，表示可以录制2秒的语音。\n3. 按钮右侧有四个竖线组成的图标，通常代表语音输入或语音识别功能。\n\n这个界面可能出现在一些应用程序或网站中，用户可以通过点击这个按钮来录制语音进行输入或识别。例如，它可以在社交媒体平台、聊天应用、搜索引擎等地方找到。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-c89eb1c9-b479-46e6-94f4-e239323ae3c9' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='eF2ok5JC' timestamp=1751777188.756044 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:29 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:29 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:46:29 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:46:29 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:29 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:29 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '方法', 'timestamp': '2025-07-06 12:46:25'}]
2025-07-06 12:46:30 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:46:30 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777190' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'text', 'content': '方法', 'timestamp': '2025-07-06 12:46:25'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='GslsSvpq' timestamp=1751777190.132564 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:30 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '方法', 'timestamp': '2025-07-06 12:46:25'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-51f0812f-c632-4da1-83dd-9ed173d27cc9' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='fQLtsI19' timestamp=1751777190.745153 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:46:31 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:46:31 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:46:36 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:46:36 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:36 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:36 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='```json\n[\n    {"type": "text", "content": "方法", "timestamp": "2025-07-06 12:46:25"}\n]\n```')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=43, candidates_tokens_details=None, prompt_token_count=14677, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=14720, traffic_type=None) invocation_id='e-51f0812f-c632-4da1-83dd-9ed173d27cc9' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='5FLnD4G4' timestamp=1751777191.157618 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:37 - utils.chat - INFO - call_agent_async:166 - Agent Response: ```json
[
    {"type": "text", "content": "方法", "timestamp": "2025-07-06 12:46:25"}
]
```
2025-07-06 12:46:37 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:46:37 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:37 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:46:37 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:46:37 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-28' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:46:40 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:46:40 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:40 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:46:40 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "image", "url": "https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/e7d009d01720451e8499830bb58a75a5.png", "content": "图中展示的是一个用户界面的截图，具体来说是一个销售任务管理的页面。以下是对于图片的详细描述：\\n\\n1. **标题区域**：\\n   - 页面顶部有一个标题栏，标题栏上写着“全部销售任务”，并有一个向上的箭头图标，表示可以展开或折叠该部分内容。\\n\\n2. **内容区域**：\\n   - 在标题栏下方，有一个矩形框，框内显示了具体的销售任务信息。\\n   - 矩形框内有两条记录：\\n     - 第一条记录是“全部销售任务”，旁边有一个勾选符号（√），表示这条任务已经被标记为完成。\\n     - 第二条记录是“未执行销售任务”，但没有进一步的信息或其他标记。\\n\\n3. **背景和颜色**：\\n   - 整个界面使用了浅紫色和白色作为主要配色方案，给人一种简洁明了的感觉。\\n   - 标题栏和矩形框之间有一条红色的边框线，可能用于区分不同的功能区域。\\n\\n4. **其他元素**：\\n   - 在矩形框的最底部，可以看到“999系统套餐”的字样，这可能是页面的底部导航或其他相关链接。\\n\\n总体来看，这个界面主要用于展示和管理用户的销售任务状态，通过勾选符号来标识已完成的任务，并提供未执行任务的列表。这种设计有助于用户快速了解当前的销售任务情况，并进行相应的管理和跟进。", "timestamp": "2025-07-06 12:46:02"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=413, candidates_tokens_details=None, prompt_token_count=13548, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=13961, traffic_type=None) invocation_id='e-3cc740d0-9e71-452b-878a-5e314a868d44' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='cwPgsJq9' timestamp=1751777179.213002 to session wxid_71rpc0hw5pj021
2025-07-06 12:46:40 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-30' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:46:40 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-31' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:46:40 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: The last_update_time provided in the session object '2025-07-06 04:46:18' is earlier than the update_time in the storage_session '2025-07-06 04:46:36'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 198, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 488, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-06 04:46:18' is earlier than the update_time in the storage_session '2025-07-06 04:46:36'. Please check if it is a stale session.
2025-07-06 12:46:40 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:46:49 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 12:46:54 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:46:54 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:46:54 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:46:54 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:46:54 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:46:54 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 12:46:55 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 12:47:11 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 12:50:08 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:50:08 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:50:08 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/94377daa8e3c42098073d19330493e2e.png', 'timestamp': '2025-07-06 12:50:03'}]
2025-07-06 12:50:08 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:50:08 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777408' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/94377daa8e3c42098073d19330493e2e.png', 'timestamp': '2025-07-06 12:50:03'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='nVngLTGl' timestamp=1751777408.7665033 to session wxid_71rpc0hw5pj021
2025-07-06 12:50:09 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/94377daa8e3c42098073d19330493e2e.png', 'timestamp': '2025-07-06 12:50:03'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-3cba6f85-ade0-48d2-978a-8987cc13e495' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='gyKX8eCG' timestamp=1751777409.337599 to session wxid_71rpc0hw5pj021
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: nVngLTGl
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:50:09 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:50:09 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:50:16 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:50:16 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:50:16 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:50:16 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=FunctionCall(id='call_f4ff6bb248e945ccadda0d', args={'image_url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/94377daa8e3c42098073d19330493e2e.png'}, name='image_comprehension'), function_response=None, text=None)], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=70, candidates_tokens_details=None, prompt_token_count=14818, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=14888, traffic_type=None) invocation_id='e-3cba6f85-ade0-48d2-978a-8987cc13e495' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=set() branch=None id='jr2wQJVg' timestamp=1751777409.707964 to session wxid_71rpc0hw5pj021
2025-07-06 12:50:17 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:50:17 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:50:17 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '1111', 'timestamp': '2025-07-06 12:50:13'}]
2025-07-06 12:50:17 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:50:17 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777417' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'text', 'content': '1111', 'timestamp': '2025-07-06 12:50:13'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='q8gZlhBb' timestamp=1751777417.9599485 to session wxid_71rpc0hw5pj021
2025-07-06 12:50:18 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '1111', 'timestamp': '2025-07-06 12:50:13'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-75649f6d-6afb-4281-bbb3-99c27c8b1e25' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='XSfhX4us' timestamp=1751777418.511698 to session wxid_71rpc0hw5pj021
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: q8gZlhBb
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: nVngLTGl
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:50:18 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:50:18 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:50:19 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-07-06 12:50:19 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b', 'request_id': '4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b', 'request_id': '4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:50:19 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:50:19 - httpx - INFO - _send_single_request:1025 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:50:19 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=FunctionResponse(will_continue=None, scheduling=None, id='call_f4ff6bb248e945ccadda0d', name='image_comprehension', response={'status': 'success', 'image_description': '图中描绘的是一个地图界面，显示了一个地理位置的标记。具体来说：\n\n1. **地图背景**：背景是一个网格状的地图，通常用于表示地理坐标系统，白色线条代表道路或边界线。\n\n2. **红色圆点**：地图中央有一个红色圆点，表示当前的位置或目标位置。\n\n3. **文字信息**：在地图下方有一行文字，内容为“东莞市佛兴路”，这表明红点所标记的位置位于东莞市的佛兴路。\n\n4. **图标和标签**：由于图片中的文字被遮挡了一部分，无法完全确定所有信息，但可以看出这是一个与地理位置相关的应用界面，可能是导航、定位或地图服务的一部分。\n\n总体来看，这张图展示了一个具体的地理位置标记，可能是在某个导航应用或地图服务中查看的一个地点。'}), text=None)], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-3cba6f85-ade0-48d2-978a-8987cc13e495' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='OgmJAZEp' timestamp=1751777419.666725 to session wxid_71rpc0hw5pj021
2025-07-06 12:50:19 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-15' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:50:19 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-16' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:50:19 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: The last_update_time provided in the session object '2025-07-06 04:50:16' is earlier than the update_time in the storage_session '2025-07-06 04:50:18'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 198, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 488, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-06 04:50:16' is earlier than the update_time in the storage_session '2025-07-06 04:50:18'. Please check if it is a stale session.
2025-07-06 12:50:19 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:51:01 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:01 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:01 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '333', 'timestamp': '2025-07-06 12:50:57'}]
2025-07-06 12:51:02 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 12:51:02 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751777462' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '333', 'timestamp': '2025-07-06 12:50:57'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='qhzAriD3' timestamp=1751777462.0011983 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:02 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '333', 'timestamp': '2025-07-06 12:50:57'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-98d72fc9-4e1a-4dda-bc8b-a843112544dc' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='2WEYD2K0' timestamp=1751777462.54484 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:02 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qhzAriD3
2025-07-06 12:51:02 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: sqQFfSug
2025-07-06 12:51:02 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: l6k90qNp
2025-07-06 12:51:02 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rb5Y3p48
2025-07-06 12:51:02 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:51:08 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:51:08 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:08 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:08 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "555", "timestamp": "2025-07-06 12:26:50"},\n    {"type": "text", "content": "555", "timestamp": "2025-07-06 12:26:55"}\n]\n\n[\n    {"type": "text", "content": "2222", "timestamp": "2025-07-06 12:27:04"}\n]\n\n[\n    {"type": "text", "content": "333", "timestamp": "2025-07-06 12:50:57"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=163, candidates_tokens_details=None, prompt_token_count=1375, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1538, traffic_type=None) invocation_id='e-98d72fc9-4e1a-4dda-bc8b-a843112544dc' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='HPlPLlDT' timestamp=1751777462.911773 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:08 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "555", "timestamp": "2025-07-06 12:26:50"},
    {"type": "text", "content": "555", "timestamp": "2025-07-06 12:26:55"}
]

[
    {"type": "text", "content": "2222", "timestamp": "2025-07-06 12:27:04"}
]

[
    {"type": "text", "content": "333", "timestamp": "2025-07-06 12:50:57"}
]
2025-07-06 12:51:08 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-24' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:51:08 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-25' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:51:08 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: Extra data: line 6 column 1 (char 156)
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 101, in process_agent_background
    agent_response = json.loads(agent_response_text.strip("```json").strip("```"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/decoder.py", line 341, in decode
    raise JSONDecodeError("Extra data", s, end)
json.decoder.JSONDecodeError: Extra data: line 6 column 1 (char 156)
2025-07-06 12:51:08 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:51:44 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:44 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:44 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '222', 'timestamp': '2025-07-06 12:51:39'}]
2025-07-06 12:51:44 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 12:51:44 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751777504' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '222', 'timestamp': '2025-07-06 12:51:39'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='qbmAfWFj' timestamp=1751777504.4970777 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:45 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '222', 'timestamp': '2025-07-06 12:51:39'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-914b24cd-d220-46f7-bfa8-1c33d86e3ae8' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='zcWtYizr' timestamp=1751777505.043351 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:45 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qbmAfWFj
2025-07-06 12:51:45 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qhzAriD3
2025-07-06 12:51:45 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: sqQFfSug
2025-07-06 12:51:45 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: l6k90qNp
2025-07-06 12:51:45 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rb5Y3p48
2025-07-06 12:51:45 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:51:47 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:51:47 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:47 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:47 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "222", "timestamp": "2025-07-06 12:51:39"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=41, candidates_tokens_details=None, prompt_token_count=1588, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1629, traffic_type=None) invocation_id='e-914b24cd-d220-46f7-bfa8-1c33d86e3ae8' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='41Ay91hX' timestamp=1751777505.409224 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:47 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "222", "timestamp": "2025-07-06 12:51:39"}
]
2025-07-06 12:51:47 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:47 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:47 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:51:47 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:51:47 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-36' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:51:49 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:49 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:51:49 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '333333', 'timestamp': '2025-07-06 12:51:45'}]
2025-07-06 12:51:49 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 12:51:49 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751777509' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '333333', 'timestamp': '2025-07-06 12:51:45'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='Iy4H5lKm' timestamp=1751777509.7234464 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:50 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '333333', 'timestamp': '2025-07-06 12:51:45'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-0b7409f3-8a11-4763-a6c0-55ce5d3964c8' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='CyKjxGol' timestamp=1751777510.268557 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:50 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: Iy4H5lKm
2025-07-06 12:51:50 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qbmAfWFj
2025-07-06 12:51:50 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qhzAriD3
2025-07-06 12:51:50 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: sqQFfSug
2025-07-06 12:51:50 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: l6k90qNp
2025-07-06 12:51:50 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rb5Y3p48
2025-07-06 12:51:50 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:51:54 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:51:54 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:54 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:51:54 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "222", "timestamp": "2025-07-06 12:51:39"}\n]\n\n[\n    {"type": "text", "content": "333333", "timestamp": "2025-07-06 12:51:45"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=85, candidates_tokens_details=None, prompt_token_count=1672, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1757, traffic_type=None) invocation_id='e-0b7409f3-8a11-4763-a6c0-55ce5d3964c8' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='8zvgq42V' timestamp=1751777510.632909 to session wxid_h5nwnc84f0di22
2025-07-06 12:51:54 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "222", "timestamp": "2025-07-06 12:51:39"}
]

[
    {"type": "text", "content": "333333", "timestamp": "2025-07-06 12:51:45"}
]
2025-07-06 12:51:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-43' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:51:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-44' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:51:54 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: Extra data: line 5 column 1 (char 80)
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 101, in process_agent_background
    agent_response = json.loads(agent_response_text.strip("```json").strip("```"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/decoder.py", line 341, in decode
    raise JSONDecodeError("Extra data", s, end)
json.decoder.JSONDecodeError: Extra data: line 5 column 1 (char 80)
2025-07-06 12:51:54 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:52:13 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:52:13 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:52:13 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '4444', 'timestamp': '2025-07-06 12:52:09'}]
2025-07-06 12:52:14 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_h5nwnc84f0di22 的状态。
2025-07-06 12:52:14 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_h5nwnc84f0di22_1751777534' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_h5nwnc84f0di22', 'session_id': 'wxid_h5nwnc84f0di22', 'user_input': [{'type': 'text', 'content': '4444', 'timestamp': '2025-07-06 12:52:09'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='rygurSvx' timestamp=1751777534.0955782 to session wxid_h5nwnc84f0di22
2025-07-06 12:52:14 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '4444', 'timestamp': '2025-07-06 12:52:09'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-1b905ad9-96c2-4108-ac0f-15a5fdb75b21' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='DxuoyUKR' timestamp=1751777534.643414 to session wxid_h5nwnc84f0di22
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rygurSvx
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: Iy4H5lKm
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qbmAfWFj
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: qhzAriD3
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: sqQFfSug
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: l6k90qNp
2025-07-06 12:52:15 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rb5Y3p48
2025-07-06 12:52:15 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:52:17 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 12:52:17 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:52:17 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:52:17 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "4444", "timestamp": "2025-07-06 12:52:09"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=42, candidates_tokens_details=None, prompt_token_count=1808, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1850, traffic_type=None) invocation_id='e-1b905ad9-96c2-4108-ac0f-15a5fdb75b21' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='h5ANPJEp' timestamp=1751777535.007798 to session wxid_h5nwnc84f0di22
2025-07-06 12:52:17 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "4444", "timestamp": "2025-07-06 12:52:09"}
]
2025-07-06 12:52:17 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 18, session_id: wxid_h5nwnc84f0di22
2025-07-06 12:52:17 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 12:52:17 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 12:52:17 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:52:17 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-55' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:52:48 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:52:48 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:52:48 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '4343', 'timestamp': '2025-07-06 12:52:43'}]
2025-07-06 12:52:48 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:52:48 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777568' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'text', 'content': '4343', 'timestamp': '2025-07-06 12:52:43'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='aRX4lKST' timestamp=1751777568.5414064 to session wxid_71rpc0hw5pj021
2025-07-06 12:52:49 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '4343', 'timestamp': '2025-07-06 12:52:43'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-33b3ddf8-f49b-43bc-8ad6-08ab59d1cb83' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='k9sbtf36' timestamp=1751777569.093483 to session wxid_71rpc0hw5pj021
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: aRX4lKST
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: q8gZlhBb
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: nVngLTGl
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:52:49 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:52:49 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:52:49 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-07-06 12:52:49 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-210871b4-4307-9fc0-8aba-f1bfc4470e56', 'request_id': '210871b4-4307-9fc0-8aba-f1bfc4470e56'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-210871b4-4307-9fc0-8aba-f1bfc4470e56', 'request_id': '210871b4-4307-9fc0-8aba-f1bfc4470e56'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:52:49 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:52:59 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:52:59 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:52:59 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/736657560cdd44f2984f1f9b602ab1fa.png', 'timestamp': '2025-07-06 12:52:54'}]
2025-07-06 12:52:59 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:52:59 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777579' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/736657560cdd44f2984f1f9b602ab1fa.png', 'timestamp': '2025-07-06 12:52:54'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='rFmiT0IT' timestamp=1751777579.6597073 to session wxid_71rpc0hw5pj021
2025-07-06 12:53:00 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'image', 'url': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/736657560cdd44f2984f1f9b602ab1fa.png', 'timestamp': '2025-07-06 12:52:54'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-6bc28a87-87e1-4cac-8d30-a4554c78d849' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='Jl5VWvVy' timestamp=1751777580.216695 to session wxid_71rpc0hw5pj021
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rFmiT0IT
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: aRX4lKST
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: q8gZlhBb
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: nVngLTGl
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:53:00 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:53:00 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:53:01 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-07-06 12:53:01 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-50df2b74-c445-9fcf-afa4-38b15ab6daf4', 'request_id': '50df2b74-c445-9fcf-afa4-38b15ab6daf4'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-50df2b74-c445-9fcf-afa4-38b15ab6daf4', 'request_id': '50df2b74-c445-9fcf-afa4-38b15ab6daf4'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:53:01 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:53:42 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:53:42 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:53:42 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'file', 'content': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dec67af61324447fa90e005a353f1a8d.xlsx', 'timestamp': '2025-07-06 12:53:37'}]
2025-07-06 12:53:42 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:53:42 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777622' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'file', 'content': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dec67af61324447fa90e005a353f1a8d.xlsx', 'timestamp': '2025-07-06 12:53:37'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='In38reNo' timestamp=1751777622.2519484 to session wxid_71rpc0hw5pj021
2025-07-06 12:53:42 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'file', 'content': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/dec67af61324447fa90e005a353f1a8d.xlsx', 'timestamp': '2025-07-06 12:53:37'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-6213497f-35c3-4980-bcb8-cb72bea76b87' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='Z7F4u6u9' timestamp=1751777622.793338 to session wxid_71rpc0hw5pj021
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: In38reNo
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rFmiT0IT
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: aRX4lKST
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: q8gZlhBb
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: nVngLTGl
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:53:43 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:53:43 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:53:43 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-07-06 12:53:43 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-72aed487-7b06-9dbd-9c1a-e36e91d2c915', 'request_id': '72aed487-7b06-9dbd-9c1a-e36e91d2c915'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-72aed487-7b06-9dbd-9c1a-e36e91d2c915', 'request_id': '72aed487-7b06-9dbd-9c1a-e36e91d2c915'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:53:43 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:54:06 - main - INFO - process_user_input:150 - 收到请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:54:06 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 18, session_id: wxid_71rpc0hw5pj021
2025-07-06 12:54:06 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'file', 'content': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/8ac4e34eeb4b4c58b689c597d5272b1c.xlsx', 'timestamp': '2025-07-06 12:54:02'}]
2025-07-06 12:54:07 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: wxid_71rpc0hw5pj021 的状态。
2025-07-06 12:54:07 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_wxid_71rpc0hw5pj021_1751777647' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '18', 'belong_chat_id': 'wxid_eh838yv64yso22', 'wechat_id': 'wxid_71rpc0hw5pj021', 'session_id': 'wxid_71rpc0hw5pj021', 'user_input': [{'type': 'file', 'content': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/8ac4e34eeb4b4c58b689c597d5272b1c.xlsx', 'timestamp': '2025-07-06 12:54:02'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='V1Tv2iUu' timestamp=1751777647.0427337 to session wxid_71rpc0hw5pj021
2025-07-06 12:54:07 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'file', 'content': 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/wechat/8ac4e34eeb4b4c58b689c597d5272b1c.xlsx', 'timestamp': '2025-07-06 12:54:02'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-e16623c5-d499-46db-926a-7a13cbb9ae94' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='lkhzsuaq' timestamp=1751777647.592457 to session wxid_71rpc0hw5pj021
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: V1Tv2iUu
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: In38reNo
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: rFmiT0IT
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: aRX4lKST
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: q8gZlhBb
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: nVngLTGl
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: GslsSvpq
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: EIERtIHG
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: vS7lZIqm
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: RMKlezeC
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: h1lph3HD
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: SDVDqA3w
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: IVenTcAM
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: J32Dk3Dm
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: oQ6facOy
2025-07-06 12:54:07 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: hSaJywKi
2025-07-06 12:54:07 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 12:54:08 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-07-06 12:54:08 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-10cab1c4-20d2-9bce-81e1-7e261ce38b95', 'request_id': '10cab1c4-20d2-9bce-81e1-7e261ce38b95'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-10cab1c4-20d2-9bce-81e1-7e261ce38b95', 'request_id': '10cab1c4-20d2-9bce-81e1-7e261ce38b95'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:54:08 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 13:10:57 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 13:11:03 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:11:03 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:11:03 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:11:03 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:11:03 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:11:03 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:11:03 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 13:11:09 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 13:11:17 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 13:11:26 - main - INFO - process_user_input:150 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 13:11:26 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 13:11:26 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 13:11:26 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 13:11:26 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751778686' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='r5Iel2vR' timestamp=1751778686.8527284 to session 1234
2025-07-06 13:11:27 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-e2ef6727-ef74-4930-a109-14500bcb16c7' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='raj6lH1X' timestamp=1751778687.485776 to session 1234
2025-07-06 13:11:27 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: r5Iel2vR
2025-07-06 13:11:27 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: CyajgLsn
2025-07-06 13:11:27 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 13:11:27 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 13:11:27 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 13:11:30 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 13:11:30 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:11:30 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:11:30 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=45, candidates_tokens_details=None, prompt_token_count=1491, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1536, traffic_type=None) invocation_id='e-e2ef6727-ef74-4930-a109-14500bcb16c7' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='PQfsD0jy' timestamp=1751778687.914398 to session 1234
2025-07-06 13:11:30 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}
]
2025-07-06 13:11:30 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 67, session_id: 1234
2025-07-06 13:11:30 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:11:30 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 13:11:30 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:11:30 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:12:02 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 13:12:07 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:12:07 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:12:07 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:12:07 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:12:07 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:12:07 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:12:07 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 13:12:14 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 13:12:14 - main - INFO - process_user_input:150 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 13:12:14 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 13:12:14 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 13:12:15 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 13:12:15 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751778735' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='A7J7vZKG' timestamp=1751778735.0854716 to session 1234
2025-07-06 13:12:15 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '9999999', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-ed271630-ce20-4b21-b431-700a821aeec8' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='tpPirxTQ' timestamp=1751778735.79645 to session 1234
2025-07-06 13:12:16 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: A7J7vZKG
2025-07-06 13:12:16 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: r5Iel2vR
2025-07-06 13:12:16 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: CyajgLsn
2025-07-06 13:12:16 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 13:12:16 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 13:12:16 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 13:12:18 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 13:12:18 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:12:18 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:12:18 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=45, candidates_tokens_details=None, prompt_token_count=1590, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1635, traffic_type=None) invocation_id='e-ed271630-ce20-4b21-b431-700a821aeec8' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='TFe3i1FZ' timestamp=1751778736.267879 to session 1234
2025-07-06 13:12:19 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}
]
2025-07-06 13:12:19 - main - INFO - process_agent_background:103 - 智能体处理完成 - user_id: 67, session_id: 1234
2025-07-06 13:12:19 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:12:19 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 13:12:19 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:12:19 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:13:47 - main - INFO - process_user_input:150 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 13:13:47 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 13:13:47 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '你好', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 13:13:47 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 13:13:47 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751778827' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '你好', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='gvASD3Xb' timestamp=1751778827.7397985 to session 1234
2025-07-06 13:13:48 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '你好', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-5cbead36-6c41-414e-9350-31f487ae349c' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='PGF1CTw3' timestamp=1751778828.440055 to session 1234
2025-07-06 13:13:48 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: gvASD3Xb
2025-07-06 13:13:48 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: A7J7vZKG
2025-07-06 13:13:48 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: r5Iel2vR
2025-07-06 13:13:48 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: CyajgLsn
2025-07-06 13:13:48 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 13:13:48 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 13:13:48 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 13:13:54 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 13:13:54 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:13:54 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:13:54 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}\n]\n\n[\n    {"type": "text", "content": "你好", "timestamp": "2025-07-06 11:09:56"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=84, candidates_tokens_details=None, prompt_token_count=1673, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1757, traffic_type=None) invocation_id='e-5cbead36-6c41-414e-9350-31f487ae349c' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='j9H3a2Jh' timestamp=1751778828.909751 to session 1234
2025-07-06 13:13:54 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "9999999", "timestamp": "2025-07-06 11:09:56"}
]

[
    {"type": "text", "content": "你好", "timestamp": "2025-07-06 11:09:56"}
]
2025-07-06 13:13:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-19' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 13:13:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-20' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:13:54 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 67, session_id: 1234, error: Extra data: line 5 column 1 (char 84)
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 101, in process_agent_background
    agent_response = json.loads(agent_response_text.strip("```json").strip("```"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/decoder.py", line 341, in decode
    raise JSONDecodeError("Extra data", s, end)
json.decoder.JSONDecodeError: Extra data: line 5 column 1 (char 84)
2025-07-06 13:13:54 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:14:40 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 13:14:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:14:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:14:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:14:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:14:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:14:45 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:14:45 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 13:14:47 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
2025-07-06 13:14:56 - main - INFO - process_user_input:151 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 13:14:56 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 13:14:56 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '你好', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 13:14:56 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 13:14:56 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751778896' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '你好', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='yXYhZ8cy' timestamp=1751778896.3897836 to session 1234
2025-07-06 13:14:57 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '你好', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-ed97ad07-ecbf-4cde-98b7-fbe22a48745a' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='qhee9IbP' timestamp=1751778897.046616 to session 1234
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: yXYhZ8cy
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: gvASD3Xb
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: A7J7vZKG
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: r5Iel2vR
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: CyajgLsn
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 13:14:57 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 13:14:57 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 13:14:59 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 13:14:59 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:14:59 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:14:59 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "你好", "timestamp": "2025-07-06 11:09:56"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=39, candidates_tokens_details=None, prompt_token_count=1805, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1844, traffic_type=None) invocation_id='e-ed97ad07-ecbf-4cde-98b7-fbe22a48745a' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='R5YiKLjA' timestamp=1751778897.481555 to session 1234
2025-07-06 13:15:00 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "你好", "timestamp": "2025-07-06 11:09:56"}
]
2025-07-06 13:15:00 - main - INFO - process_agent_background:104 - 智能体处理完成 - user_id: 67, session_id: 1234
2025-07-06 13:15:00 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:15:00 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 13:15:00 - main - ERROR - process_agent_background:118 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:15:00 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:16:44 - main - INFO - process_user_input:151 - 收到请求 - user_id: 67, session_id: 1234
2025-07-06 13:16:44 - main - INFO - process_agent_background:86 - 开始后台处理请求 - user_id: 67, session_id: 1234
2025-07-06 13:16:44 - utils.chat - INFO - call_agent_async:111 - User Query: [{'type': 'text', 'content': '我想买你的产品', 'timestamp': '2025-07-06 11:09:56'}]
2025-07-06 13:16:45 - utils.chat - INFO - call_agent_async:133 - 更新现有会话: 1234 的状态。
2025-07-06 13:16:45 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=None grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='inv_1234_1751779005' author='system' actions=EventActions(skip_summarization=None, state_delta={'tenant_id': '1', 'task_id': '67', 'belong_chat_id': '214324we', 'wechat_id': 'wertbvtgtre', 'session_id': '1234', 'user_input': [{'type': 'text', 'content': '我想买你的产品', 'timestamp': '2025-07-06 11:09:56'}]}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='ZM7yaXrS' timestamp=1751779005.0242474 to session 1234
2025-07-06 13:16:45 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text="[{'type': 'text', 'content': '我想买你的产品', 'timestamp': '2025-07-06 11:09:56'}]")], role='user') grounding_metadata=None partial=None turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=None invocation_id='e-7523bc1a-0687-44f3-aad2-7866602505ff' author='user' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='i5UQA9xz' timestamp=1751779005.68094 to session 1234
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: ZM7yaXrS
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: yXYhZ8cy
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: gvASD3Xb
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: A7J7vZKG
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: r5Iel2vR
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: CyajgLsn
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: y34m15eT
2025-07-06 13:16:46 - google_adk.google.adk.runners - WARNING - _find_agent_to_run:351 - Event from an unknown agent: system, event id: PLCeLPnA
2025-07-06 13:16:46 - LiteLLM - INFO - _check_valid_arg:3108 - 
LiteLLM completion() model= qwen-max-latest; provider = openai
2025-07-06 13:16:48 - httpx - INFO - _send_single_request:1740 - HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
2025-07-06 13:16:48 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:16:48 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:16:48 - google_adk.google.adk.sessions.database_session_service - INFO - append_event:474 - Append event: content=Content(parts=[Part(video_metadata=None, thought=None, inline_data=None, code_execution_result=None, executable_code=None, file_data=None, function_call=None, function_response=None, text='[\n    {"type": "text", "content": "我想买你的产品", "timestamp": "2025-07-06 11:09:56"}\n]')], role='model') grounding_metadata=None partial=False turn_complete=None error_code=None error_message=None interrupted=None custom_metadata=None usage_metadata=GenerateContentResponseUsageMetadata(cache_tokens_details=None, cached_content_token_count=None, candidates_token_count=42, candidates_tokens_details=None, prompt_token_count=1895, prompt_tokens_details=None, thoughts_token_count=None, tool_use_prompt_token_count=None, tool_use_prompt_tokens_details=None, total_token_count=1937, traffic_type=None) invocation_id='e-7523bc1a-0687-44f3-aad2-7866602505ff' author='input_process_agent' actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}) long_running_tool_ids=None branch=None id='ItCfHMSY' timestamp=1751779006.11587 to session 1234
2025-07-06 13:16:48 - utils.chat - INFO - call_agent_async:166 - Agent Response: [
    {"type": "text", "content": "我想买你的产品", "timestamp": "2025-07-06 11:09:56"}
]
2025-07-06 13:16:48 - main - INFO - process_agent_background:104 - 智能体处理完成 - user_id: 67, session_id: 1234
2025-07-06 13:16:48 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: openai/qwen-max-latest
2025-07-06 13:16:48 - LiteLLM - INFO - completion_cost:636 - selected model name for cost calculation: qwen-max-latest
2025-07-06 13:16:48 - main - ERROR - process_agent_background:118 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:16:48 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-22' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:22:44 - api - INFO - shutdown_event:140 - 角色创建服务正在关闭
2025-07-06 13:22:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:22:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:22:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:22:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for gemini-.* from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:22:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/endpoints\/.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:22:49 - google_adk.google.adk.models.registry - INFO - _register:64 - Updating LLM class for projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+ from <class 'google.adk.models.google_llm.Gemini'> to <class 'google.adk.models.google_llm.Gemini'>
2025-07-06 13:22:50 - api - INFO - startup_event:135 - 角色创建服务启动完成
2025-07-06 13:22:51 - google_adk.google.adk.sessions.database_session_service - INFO - __init__:265 - Local timezone: Asia/Shanghai
