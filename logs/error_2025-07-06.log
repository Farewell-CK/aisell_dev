2025-07-06 11:08:55 - main - ERROR - process_agent_background:126 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: (pymysql.err.OperationalError) (2006, "MySQL server has gone away (TimeoutError(110, 'Connection timed out'))")
[SQL: SELECT sessions.app_name AS sessions_app_name, sessions.user_id AS sessions_user_id, sessions.id AS sessions_id, sessions.state AS sessions_state, sessions.create_time AS sessions_create_time, sessions.update_time AS sessions_update_time 
FROM sessions 
WHERE sessions.app_name = %(pk_1)s AND sessions.user_id = %(pk_2)s AND sessions.id = %(pk_3)s]
[parameters: {'pk_1': 'ai_sales_agent', 'pk_2': '18', 'pk_3': 'wxid_h5nwnc84f0di22'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 806, in _write_bytes
    self._sock.sendall(data)
TimeoutError: [Errno 110] Connection timed out

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 864, in _execute_command
    self._write_bytes(packet)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 809, in _write_bytes
    raise err.OperationalError(
pymysql.err.OperationalError: (2006, "MySQL server has gone away (TimeoutError(110, 'Connection timed out'))")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 114, in call_agent_async
    session = await runner.session_service.get_session(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 367, in get_session
    storage_session = session_factory.get(
                      ^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3694, in get
    return self._get_impl(
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3874, in _get_impl
    return db_load_fn(
           ^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 694, in load_on_pk_identity
    session.execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2251, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1416, in execute
    return meth(
           ^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 864, in _execute_command
    self._write_bytes(packet)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 809, in _write_bytes
    raise err.OperationalError(
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (2006, "MySQL server has gone away (TimeoutError(110, 'Connection timed out'))")
[SQL: SELECT sessions.app_name AS sessions_app_name, sessions.user_id AS sessions_user_id, sessions.id AS sessions_id, sessions.state AS sessions_state, sessions.create_time AS sessions_create_time, sessions.update_time AS sessions_update_time 
FROM sessions 
WHERE sessions.app_name = %(pk_1)s AND sessions.user_id = %(pk_2)s AND sessions.id = %(pk_3)s]
[parameters: {'pk_1': 'ai_sales_agent', 'pk_2': '18', 'pk_3': 'wxid_h5nwnc84f0di22'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-06 11:08:55 - main - ERROR - process_agent_background:146 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: send_chat() missing 1 required positional argument: 'belong_chat_id'
2025-07-06 11:10:00 - main - ERROR - process_agent_background:126 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:09:56'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 144, in call_agent_async
    content = types.Content(role='user', parts=[types.Part(text=query)])
                                                ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:09:56'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-06 11:10:00 - main - ERROR - process_agent_background:146 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: send_chat() missing 1 required positional argument: 'belong_chat_id'
2025-07-06 11:10:14 - main - ERROR - process_agent_background:126 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:10:10'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 144, in call_agent_async
    content = types.Content(role='user', parts=[types.Part(text=query)])
                                                ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Part
text
  Input should be a valid string [type=string_type, input_value=[{'type': 'text', 'conten... '2025-07-06 11:10:10'}], input_type=list]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-06 11:10:14 - main - ERROR - process_agent_background:146 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: send_chat() missing 1 required positional argument: 'belong_chat_id'
2025-07-06 12:16:47 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:16:47 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:18:02 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:18:02 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:20:44 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:20:44 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:25:32 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:25:32 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:27:01 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:27:01 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:27:10 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:27:10 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:28:22 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:28:22 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:28:44 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:28:44 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:29:47 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:29:47 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:32:15 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:32:15 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:32:28 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:32:28 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:33:38 - main - ERROR - process_agent_background:127 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'lower'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 142, in run_async
    if event := await self.__handle_before_agent_callback(ctx):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 293, in __handle_before_agent_callback
    before_agent_callback_content = callback(
                                    ^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/tools/callbacks.py", line 45, in check_prompt_protection
    if re.search(pattern, user_input.lower()):
                          ^^^^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'lower'
2025-07-06 12:33:38 - main - ERROR - process_agent_background:148 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:34:58 - main - ERROR - process_agent_background:121 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 12:34:58 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:42:58 - main - ERROR - process_agent_background:121 - 发送通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:42:58 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-36' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:46:37 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:46:37 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-28' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:46:40 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-30' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:46:40 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-31' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:46:40 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: The last_update_time provided in the session object '2025-07-06 04:46:18' is earlier than the update_time in the storage_session '2025-07-06 04:46:36'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 198, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 488, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-06 04:46:18' is earlier than the update_time in the storage_session '2025-07-06 04:46:36'. Please check if it is a stale session.
2025-07-06 12:46:40 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:50:19 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b', 'request_id': '4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b', 'request_id': '4c604bb3-1a6e-9a1e-a86e-76cf3df9f13b'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:50:19 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:50:19 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-15' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:50:19 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-16' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:50:19 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: The last_update_time provided in the session object '2025-07-06 04:50:16' is earlier than the update_time in the storage_session '2025-07-06 04:50:18'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 198, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 488, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-06 04:50:16' is earlier than the update_time in the storage_session '2025-07-06 04:50:18'. Please check if it is a stale session.
2025-07-06 12:50:19 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:51:08 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-24' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:51:08 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-25' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:51:08 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: Extra data: line 6 column 1 (char 156)
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 101, in process_agent_background
    agent_response = json.loads(agent_response_text.strip("```json").strip("```"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/decoder.py", line 341, in decode
    raise JSONDecodeError("Extra data", s, end)
json.decoder.JSONDecodeError: Extra data: line 6 column 1 (char 156)
2025-07-06 12:51:08 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:51:47 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:51:47 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-36' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:51:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-43' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 12:51:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-44' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:51:54 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: Extra data: line 5 column 1 (char 80)
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 101, in process_agent_background
    agent_response = json.loads(agent_response_text.strip("```json").strip("```"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/decoder.py", line 341, in decode
    raise JSONDecodeError("Extra data", s, end)
json.decoder.JSONDecodeError: Extra data: line 5 column 1 (char 80)
2025-07-06 12:51:54 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:52:17 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 18, session_id: wxid_h5nwnc84f0di22, error: 'list' object has no attribute 'get'
2025-07-06 12:52:17 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-55' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 12:52:49 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-210871b4-4307-9fc0-8aba-f1bfc4470e56', 'request_id': '210871b4-4307-9fc0-8aba-f1bfc4470e56'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-210871b4-4307-9fc0-8aba-f1bfc4470e56', 'request_id': '210871b4-4307-9fc0-8aba-f1bfc4470e56'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:52:49 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:53:01 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-50df2b74-c445-9fcf-afa4-38b15ab6daf4', 'request_id': '50df2b74-c445-9fcf-afa4-38b15ab6daf4'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-50df2b74-c445-9fcf-afa4-38b15ab6daf4', 'request_id': '50df2b74-c445-9fcf-afa4-38b15ab6daf4'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:53:01 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:53:43 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-72aed487-7b06-9dbd-9c1a-e36e91d2c915', 'request_id': '72aed487-7b06-9dbd-9c1a-e36e91d2c915'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-72aed487-7b06-9dbd-9c1a-e36e91d2c915', 'request_id': '72aed487-7b06-9dbd-9c1a-e36e91d2c915'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:53:43 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 12:54:08 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-10cab1c4-20d2-9bce-81e1-7e261ce38b95', 'request_id': '10cab1c4-20d2-9bce-81e1-7e261ce38b95'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-10cab1c4-20d2-9bce-81e1-7e261ce38b95', 'request_id': '10cab1c4-20d2-9bce-81e1-7e261ce38b95'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 94, in process_agent_background
    agent_response_text = loop.run_until_complete(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 151, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 196, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/sequential_agent.py", line 37, in _run_async_impl
    async for event in sub_agent.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 278, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 279, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 305, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 522, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 731, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 94, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[30].role
2025-07-06 12:54:08 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 18, session_id: wxid_71rpc0hw5pj021, error: 'list' object has no attribute 'get'
2025-07-06 13:11:30 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:11:30 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:12:19 - main - ERROR - process_agent_background:117 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:12:19 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:13:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-19' coro=<Logging.async_success_handler() running at /home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/litellm_logging.py:1732>>
2025-07-06 13:13:54 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-20' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:13:54 - main - ERROR - process_agent_background:123 - 后台处理失败 - user_id: 67, session_id: 1234, error: Extra data: line 5 column 1 (char 84)
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/main.py", line 101, in process_agent_background
    agent_response = json.loads(agent_response_text.strip("```json").strip("```"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/__init__.py", line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/json/decoder.py", line 341, in decode
    raise JSONDecodeError("Extra data", s, end)
json.decoder.JSONDecodeError: Extra data: line 5 column 1 (char 84)
2025-07-06 13:13:54 - main - ERROR - process_agent_background:144 - 发送错误通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:15:00 - main - ERROR - process_agent_background:118 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:15:00 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-12' coro=<<async_generator_athrow without __name__>()>>
2025-07-06 13:16:48 - main - ERROR - process_agent_background:118 - 发送通知失败 - user_id: 67, session_id: 1234, error: 'list' object has no attribute 'get'
2025-07-06 13:16:48 - asyncio - ERROR - default_exception_handler:1833 - Task was destroyed but it is pending!
task: <Task pending name='Task-22' coro=<<async_generator_athrow without __name__>()>>
