2025-07-21 17:13:21 - utils - ERROR - create_one_to_N_role:340 - 角色创建失败 - 租户ID: 1, 任务ID: 160, 策略ID: 366, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:13:21 - utils - ERROR - create_one_to_N_role_background:351 - 后台one_to_N角色创建任务失败 - 租户ID: 1, 任务ID: 160, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 348, in create_one_to_N_role_background
    await create_one_to_N_role(tenant_id, task_id, strategy_id)
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:13:44 - utils - ERROR - create_one_to_N_role:340 - 角色创建失败 - 租户ID: 1, 任务ID: 161, 策略ID: 367, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:13:44 - utils - ERROR - create_one_to_N_role_background:351 - 后台one_to_N角色创建任务失败 - 租户ID: 1, 任务ID: 161, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 348, in create_one_to_N_role_background
    await create_one_to_N_role(tenant_id, task_id, strategy_id)
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:16:20 - utils - ERROR - create_one_to_N_role:340 - 角色创建失败 - 租户ID: 1, 任务ID: 167, 策略ID: 371, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:16:20 - utils - ERROR - create_one_to_N_role_background:351 - 后台one_to_N角色创建任务失败 - 租户ID: 1, 任务ID: 167, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 348, in create_one_to_N_role_background
    await create_one_to_N_role(tenant_id, task_id, strategy_id)
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:18:46 - utils - ERROR - create_one_to_N_role:340 - 角色创建失败 - 租户ID: 1, 任务ID: 159, 策略ID: 365, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:18:46 - utils - ERROR - create_one_to_N_role_background:351 - 后台one_to_N角色创建任务失败 - 租户ID: 1, 任务ID: 159, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 348, in create_one_to_N_role_background
    await create_one_to_N_role(tenant_id, task_id, strategy_id)
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:19:56 - utils - ERROR - create_one_to_N_role:340 - 角色创建失败 - 租户ID: 1, 任务ID: 160, 策略ID: 366, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:19:56 - utils - ERROR - create_one_to_N_role_background:351 - 后台one_to_N角色创建任务失败 - 租户ID: 1, 任务ID: 160, 错误: 'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 348, in create_one_to_N_role_background
    await create_one_to_N_role(tenant_id, task_id, strategy_id)
  File "/home/funhpc/workspace/aisell_dev/utils/create_role.py", line 303, in create_one_to_N_role
    insert_opening_remarks(tenant_id, strategy_id, opening_remarks, 'system')
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 47, in insert_opening_remarks
    '{item['content']}', -- 例如: '您好，请问有什么可以帮助您的吗？'
      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:24:44 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:25:45 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:26:36 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:26:38 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:28:07 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:30:39 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-21 17:34:01 - api.chat_test_service - ERROR - chat:73 - 处理请求时发生错误: Error code: 400 - {'error': {'code': None, 'param': None, 'message': "role is not one of ['system', 'assistant', 'user', 'tool', 'function'] - 'messages.['5].role'", 'type': 'invalid_request_error'}, 'request_id': 'chatcmpl-6ba4efe0-4a41-94d2-8988-1a7fbf6a9767'}
2025-07-21 17:37:24 - api.chat_test_service - ERROR - chat:73 - 处理请求时发生错误: Error code: 400 - {'error': {'code': None, 'param': None, 'message': "role is not one of ['system', 'assistant', 'user', 'tool', 'function'] - 'messages.['5].role'", 'type': 'invalid_request_error'}, 'request_id': 'chatcmpl-01183ebd-f631-922e-9823-74af13b40b62'}
2025-07-21 17:43:38 - api.chat_test_service - ERROR - chat:73 - 处理请求时发生错误: Error code: 400 - {'error': {'code': None, 'param': None, 'message': "role is not one of ['system', 'assistant', 'user', 'tool', 'function'] - 'messages.['5].role'", 'type': 'invalid_request_error'}, 'request_id': 'chatcmpl-3b1a19d4-271c-9ba0-b0aa-42140a7b1839'}
2025-07-21 18:06:52 - summarizer - ERROR - summarize_video:1832 - 使用模型分析视频 'https://ai-yuying.oss-cn-shenzhen.aliyuncs.com/knowledge-base/802d4c89dad84c3481f54324ea42d802.mp4/公司宣传片.mp4' 时出错: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: The video modality input does not meet the requirements because: The video file is too long.', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-ee157ed2-4b91-9597-97f7-8d1762d8c69c', 'request_id': 'ee157ed2-4b91-9597-97f7-8d1762d8c69c'}
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/file_description.py", line 1822, in summarize_video
    response = self.client.chat.completions.create(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 925, in create
    return self._post(
           ^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1239, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1034, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: The video modality input does not meet the requirements because: The video file is too long.', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-ee157ed2-4b91-9597-97f7-8d1762d8c69c', 'request_id': 'ee157ed2-4b91-9597-97f7-8d1762d8c69c'}
2025-07-21 18:41:37 - api.chat_test_service - ERROR - chat:72 - 处理请求时发生错误: Expecting value: line 1 column 1 (char 0)
2025-07-21 18:41:54 - api.chat_test_service - ERROR - chat:72 - 处理请求时发生错误: Expecting value: line 1 column 1 (char 0)
2025-07-21 19:40:17 - api.chat_test_service - ERROR - chat:72 - 处理请求时发生错误: Expecting value: line 1 column 1 (char 0)
2025-07-21 20:08:25 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 168, session_id: a37021352, error: (pymysql.err.OperationalError) (2013, 'Lost connection to MySQL server during query ([Errno 110] Connection timed out)')
[SQL: SELECT sessions.app_name AS sessions_app_name, sessions.user_id AS sessions_user_id, sessions.id AS sessions_id, sessions.state AS sessions_state, sessions.create_time AS sessions_create_time, sessions.update_time AS sessions_update_time 
FROM sessions 
WHERE sessions.app_name = %(pk_1)s AND sessions.user_id = %(pk_2)s AND sessions.id = %(pk_3)s]
[parameters: {'pk_1': 'ai_sales_agent_v2', 'pk_2': '168', 'pk_3': 'a37021352168'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 782, in _read_bytes
    data = self._rfile.read(num_bytes)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/socket.py", line 720, in readinto
    return self._sock.recv_into(b)
           ^^^^^^^^^^^^^^^^^^^^^^^
TimeoutError: [Errno 110] Connection timed out

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 825, in _read_query_result
    result.read()
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 744, in _read_packet
    packet_header = self._read_bytes(4)
                    ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 788, in _read_bytes
    raise err.OperationalError(
pymysql.err.OperationalError: (2013, 'Lost connection to MySQL server during query ([Errno 110] Connection timed out)')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 113, in call_agent_async
    session = await runner.session_service.get_session(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 432, in get_session
    storage_session = session_factory.get(
                      ^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3694, in get
    return self._get_impl(
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3874, in _get_impl
    return db_load_fn(
           ^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 694, in load_on_pk_identity
    session.execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2251, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1416, in execute
    return meth(
           ^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 825, in _read_query_result
    result.read()
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 744, in _read_packet
    packet_header = self._read_bytes(4)
                    ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pymysql/connections.py", line 788, in _read_bytes
    raise err.OperationalError(
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (2013, 'Lost connection to MySQL server during query ([Errno 110] Connection timed out)')
[SQL: SELECT sessions.app_name AS sessions_app_name, sessions.user_id AS sessions_user_id, sessions.id AS sessions_id, sessions.state AS sessions_state, sessions.create_time AS sessions_create_time, sessions.update_time AS sessions_update_time 
FROM sessions 
WHERE sessions.app_name = %(pk_1)s AND sessions.user_id = %(pk_2)s AND sessions.id = %(pk_3)s]
[parameters: {'pk_1': 'ai_sales_agent_v2', 'pk_2': '168', 'pk_3': 'a37021352168'}]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-07-21 20:13:00 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 153, session_id: wxid_8d9ory4pas3422, error: The last_update_time provided in the session object '2025-07-21 20:12:51' is earlier than the update_time in the storage_session '2025-07-21 20:12:57'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-21 20:12:51' is earlier than the update_time in the storage_session '2025-07-21 20:12:57'. Please check if it is a stale session.
2025-07-21 20:44:37 - summarizer - ERROR - read_table:632 - 读取本地文件 '/tmp/tmp_wfd_zao.xls' 出错: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 135, in import_optional_dependency
    module = importlib.import_module(name)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1324, in _find_and_load_unlocked
ModuleNotFoundError: No module named 'xlrd'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/file_description.py", line 621, in read_table
    df = pd.read_excel(file_path_or_url)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 495, in read_excel
    io = ExcelFile(
         ^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 1567, in __init__
    self._reader = self._engines[engine](
                   ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_xlrd.py", line 45, in __init__
    import_optional_dependency("xlrd", extra=err_msg)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 138, in import_optional_dependency
    raise ImportError(msg)
ImportError: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
2025-07-21 20:45:54 - summarizer - ERROR - read_table:632 - 读取本地文件 '/tmp/tmp6m1wae1f.xls' 出错: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 135, in import_optional_dependency
    module = importlib.import_module(name)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1324, in _find_and_load_unlocked
ModuleNotFoundError: No module named 'xlrd'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/file_description.py", line 621, in read_table
    df = pd.read_excel(file_path_or_url)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 495, in read_excel
    io = ExcelFile(
         ^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 1567, in __init__
    self._reader = self._engines[engine](
                   ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_xlrd.py", line 45, in __init__
    import_optional_dependency("xlrd", extra=err_msg)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 138, in import_optional_dependency
    raise ImportError(msg)
ImportError: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
2025-07-21 20:46:48 - summarizer - ERROR - read_table:632 - 读取本地文件 '/tmp/tmp600d0a99.xls' 出错: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 135, in import_optional_dependency
    module = importlib.import_module(name)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1324, in _find_and_load_unlocked
ModuleNotFoundError: No module named 'xlrd'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/file_description.py", line 621, in read_table
    df = pd.read_excel(file_path_or_url)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 495, in read_excel
    io = ExcelFile(
         ^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 1567, in __init__
    self._reader = self._engines[engine](
                   ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_xlrd.py", line 45, in __init__
    import_optional_dependency("xlrd", extra=err_msg)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 138, in import_optional_dependency
    raise ImportError(msg)
ImportError: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
2025-07-21 20:47:46 - summarizer - ERROR - read_table:632 - 读取本地文件 '/tmp/tmpj6vwu6nf.xls' 出错: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 135, in import_optional_dependency
    module = importlib.import_module(name)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1324, in _find_and_load_unlocked
ModuleNotFoundError: No module named 'xlrd'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/file_description.py", line 621, in read_table
    df = pd.read_excel(file_path_or_url)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 495, in read_excel
    io = ExcelFile(
         ^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_base.py", line 1567, in __init__
    self._reader = self._engines[engine](
                   ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/io/excel/_xlrd.py", line 45, in __init__
    import_optional_dependency("xlrd", extra=err_msg)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/pandas/compat/_optional.py", line 138, in import_optional_dependency
    raise ImportError(msg)
ImportError: Missing optional dependency 'xlrd'. Install xlrd >= 2.0.1 for xls Excel support Use pip or conda to install xlrd.
2025-07-22 08:32:11 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 168, session_id: a37021352, error: The last_update_time provided in the session object '2025-07-22 08:31:55' is earlier than the update_time in the storage_session '2025-07-22 08:32:05'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-22 08:31:55' is earlier than the update_time in the storage_session '2025-07-22 08:32:05'. Please check if it is a stale session.
2025-07-22 09:11:24 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 153, session_id: WJE1193342535, error: The last_update_time provided in the session object '2025-07-22 09:11:14' is earlier than the update_time in the storage_session '2025-07-22 09:11:22'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-22 09:11:14' is earlier than the update_time in the storage_session '2025-07-22 09:11:22'. Please check if it is a stale session.
2025-07-22 09:43:09 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
2025-07-22 09:58:20 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 170, session_id: a37021352, error: The last_update_time provided in the session object '2025-07-22 09:58:10' is earlier than the update_time in the storage_session '2025-07-22 09:58:16'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-22 09:58:10' is earlier than the update_time in the storage_session '2025-07-22 09:58:16'. Please check if it is a stale session.
2025-07-22 09:59:04 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 170, session_id: a37021352, error: The last_update_time provided in the session object '2025-07-22 09:58:55' is earlier than the update_time in the storage_session '2025-07-22 09:59:01'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-22 09:58:55' is earlier than the update_time in the storage_session '2025-07-22 09:59:01'. Please check if it is a stale session.
2025-07-22 10:08:10 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 170, session_id: a37021352, error: The last_update_time provided in the session object '2025-07-22 10:07:58' is earlier than the update_time in the storage_session '2025-07-22 10:08:04'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-22 10:07:58' is earlier than the update_time in the storage_session '2025-07-22 10:08:04'. Please check if it is a stale session.
2025-07-22 10:08:29 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 153, session_id: WJE1193342535, error: The last_update_time provided in the session object '2025-07-22 10:08:06' is earlier than the update_time in the storage_session '2025-07-22 10:08:23'. Please check if it is a stale session.
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 205, in run_async
    await self.session_service.append_event(session=session, event=event)
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/sessions/database_session_service.py", line 533, in append_event
    raise ValueError(
ValueError: The last_update_time provided in the session object '2025-07-22 10:08:06' is earlier than the update_time in the storage_session '2025-07-22 10:08:23'. Please check if it is a stale session.
2025-07-22 11:09:33 - test - ERROR - process_agent_background:175 - 后台处理失败 - user_id: 149, session_id: WJE1193342535, error: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[53].role
Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 790, in acompletion
    headers, response = await self.make_openai_chat_completion_request(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/logging_utils.py", line 135, in async_wrapper
    result = await func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 436, in make_openai_chat_completion_request
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 418, in make_openai_chat_completion_request
    await openai_aclient.chat.completions.with_raw_response.create(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_legacy_response.py", line 381, in wrapped
    return cast(LegacyAPIResponse[R], await func(*args, **kwargs))
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2028, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1742, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/openai/_base_client.py", line 1549, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[53].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-dbc7339f-3d7c-9dbd-907c-366f6bd63a00', 'request_id': 'dbc7339f-3d7c-9dbd-907c-366f6bd63a00'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 477, in acompletion
    response = await init_response
               ^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/llms/openai/openai.py", line 837, in acompletion
    raise OpenAIError(
litellm.llms.openai.common_utils.OpenAIError: Error code: 400 - {'error': {'code': 'invalid_parameter_error', 'param': None, 'message': '<400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[53].role', 'type': 'invalid_request_error'}, 'id': 'chatcmpl-dbc7339f-3d7c-9dbd-907c-366f6bd63a00', 'request_id': 'dbc7339f-3d7c-9dbd-907c-366f6bd63a00'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/test.py", line 146, in process_agent_background
    agent_response_text = asyncio.run(call_agent_async(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/funhpc/workspace/aisell_dev/utils/chat.py", line 152, in call_agent_async
    async for event in runner.run_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/runners.py", line 203, in run_async
    async for event in invocation_context.agent.run_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/base_agent.py", line 147, in run_async
    async for event in self._run_async_impl(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/agents/llm_agent.py", line 275, in _run_async_impl
    async for event in self._llm_flow.run_async(ctx):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 282, in run_async
    async for event in self._run_one_step_async(invocation_context):
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 314, in _run_one_step_async
    async for llm_response in self._call_llm_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/flows/llm_flows/base_llm_flow.py", line 539, in _call_llm_async
    async for llm_response in llm.generate_content_async(
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 778, in generate_content_async
    response = await self.llm_client.acompletion(**completion_args)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/google/adk/models/lite_llm.py", line 101, in acompletion
    return await acompletion(
           ^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1460, in wrapper_async
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/utils.py", line 1321, in wrapper_async
    result = await original_function(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/main.py", line 496, in acompletion
    raise exception_type(
          ^^^^^^^^^^^^^^^
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 2214, in exception_type
    raise e
  File "/home/funhpc/miniconda3/envs/adk/lib/python3.12/site-packages/litellm/litellm_core_utils/exception_mapping_utils.py", line 328, in exception_type
    raise BadRequestError(
litellm.exceptions.BadRequestError: litellm.BadRequestError: OpenAIException - <400> InternalError.Algo.InvalidParameter: An assistant message with "tool_calls" must be followed by tool messages responding to each "tool_call_id". The following tool_call_ids did not have response messages: message[53].role
2025-07-22 15:35:11 - database - ERROR - insert_opening_remarks:69 - 插入开场白内容失败：'content'
Traceback (most recent call last):
  File "/home/funhpc/workspace/aisell_dev/utils/db_insert.py", line 67, in insert_opening_remarks
    logger.info(f"成功插入开场白内容：tenant_id={tenant_id}, strategy_id={strategy_id}, type={item['type']}, content={item['content']}")
                                                                                                                      ~~~~^^^^^^^^^^^
KeyError: 'content'
